<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <title>Admin Roles Management - Super Admin</title>
    <meta name="robots" content="noindex, follow" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="shortcut icon" type="image/x-icon" href="assets/images/favicon.ico">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="assets/css/plugins/icofont.min.css">
    <link rel="stylesheet" href="assets/css/plugins/flaticon.css">
    <link rel="stylesheet" href="assets/css/plugins/font-awesome.min.css">
    <link rel="stylesheet" href="assets/css/plugins/animate.min.css">
    <link rel="stylesheet" href="assets/css/plugins/swiper-bundle.min.css">
    <link rel="stylesheet" href="assets/css/plugins/magnific-popup.css">
    <link rel="stylesheet" href="assets/css/plugins/nice-select.css">
    <link rel="stylesheet" href="assets/css/style.css">
    <style>
        /* Admin Tab Menu as Main Sidebar */
        .admin-tab-menu {
            position: fixed;
            left: 0;
            top: 80px;
            bottom: 0;
            width: 250px;
            background: #fff;
            padding: 20px ;
            padding-left: 20px;
            z-index: 100;
            overflow-y: auto;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            border-right: 1px solid #e9ecef;
        }
        
        .admin-tab-menu a {
            display: block;
            padding: 12px 25px;
            color: #495057;
            text-decoration: none;
            border-left: 3px solid transparent;
            transition: all 0.3s ease;
            font-weight: 500;
            font-size: 14px;
        }
        
        .admin-tab-menu a:hover {
            background-color: #f8f9fa;
            color: #007bff;
            border-left-color: #007bff;
        }
        
        .admin-tab-menu a.active {
            background-color: #e7f3ff;
            color: #007bff;
            border-left-color: #007bff;
            font-weight: 600;
        }
        
        .page-content-wrapper {
            margin-left: 250px;
        }
        
        .main-content-wrapper {
            padding: 20px;
        }
        
        @media (max-width: 768px) {
            .admin-tab-menu {
                position: relative;
                left: 0;
                top: 0;
                width: 100%;
                margin-bottom: 20px;
                max-height: 300px;
            }
            
            .page-content-wrapper {
                margin-left: 0;
            }
        }
    </style>
</head>

<body>

    <div class="main-wrapper main-wrapper-02">

        <!-- Login Header Start -->
        <div class="section login-header">
            <div class="login-header-wrapper navbar navbar-expand">
                
                <div class="login-header-logo">
                    <a href="super-admin-dashboard.html"><img src="assets/images/logo-icon.png" alt="Logo"></a>
                </div>
                <div class="login-header-action ml-auto">
                    <a class="action author" href="#">
                        <img src="assets/images/author/author-07.jpg" alt="Author">
                    </a>
                    <div class="dropdown">
                        <button class="action more" data-bs-toggle="dropdown">
                            <span></span>
                            <span></span>
                            <span></span>
                        </button>
                        <ul class="dropdown-menu">
                            <li><a href="super-admin-dashboard.html"><i class="icofont-home"></i> Dashboard</a></li>
                            <li><a href="login.html"><i class="icofont-logout"></i> Sign Out</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Roles Admin Start -->
        <div class="section overflow-hidden position-relative" id="wrapper">
            <div class="page-content-wrapper py-0">
                <!-- Admin Tab Menu Start - Main Sidebar -->
                <div class="nav flex-column nav-pills admin-tab-menu">
                    <a href="super-admin-dashboard.html">Dashboard</a>
                    <a href="super-admin-courses.html" data-permission="view_courses">Courses</a>
                    <a href="super-admin-students.html" data-permission="view_students">Students</a>
                    <a href="super-admin-tutors.html" data-permission="view_tutors">Tutors</a>
                    <a href="super-admin-payments.html" data-permission="view_payments">Payments</a>
                    <a href="super-admin-roles.html" data-role="super_admin">Admin Roles</a>
                    <a href="super-admin-blog.html" data-permission="view_blog_posts">Blog</a>
                </div>
                <!-- Admin Tab Menu End -->

                <div class="main-content-wrapper">
                    <div class="container-fluid">
                        <div class="admin-top-bar flex-wrap mb-4">
                            <div>
                                <h3 class="title mb-2">Admin Roles & Permissions</h3>
                                <p class="text-muted">Set roles for admins and assign permissions</p>
                            </div>
                            <button class="btn btn-sm btn-primary px-3 py-2 small" data-bs-toggle="modal" data-bs-target="#createAdminModal" data-permission="create_admin" style="font-size: 0.75rem;">
                                <i class="icofont-plus me-1"></i> Create New Admin
                            </button>
                        </div>

                        <!-- Admins List -->
                        <div class="card border-0 shadow-sm mb-4">
                            <div class="card-header bg-white border-0 py-3">
                                <h5 class="mb-0">Admins List</h5>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>Name</th>
                                                <th>Email</th>
                                                <th>Role</th>
                                                <th>Permissions</th>
                                                <th>Status</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="adminsTableBody">
                                            <tr>
                                                <td colspan="6" class="text-center">
                                                    <div class="spinner-border text-primary" role="status">
                                                        <span class="visually-hidden">Loading...</span>
                                                    </div>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Create Admin Modal -->
        <div class="modal fade" id="createAdminModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Create New Admin</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form>
                            <div class="mb-3">
                                <label class="form-label">Full Name</label>
                                <input type="text" class="form-control" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Email</label>
                                <input type="email" class="form-control" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Password</label>
                                <input type="password" class="form-control" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Role</label>
                                <select class="form-control" required>
                                    <option>Admin</option>
                                </select>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-sm btn-secondary px-3 py-2 small" data-bs-dismiss="modal" style="font-size: 0.75rem;">Cancel</button>
                        <button type="button" class="btn btn-sm btn-primary px-3 py-2 small" onclick="createAdmin()" style="font-size: 0.75rem;">Create Admin</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Edit Permissions Modal -->
        <div class="modal fade" id="editPermissionsModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="editPermissionsModalTitle">Assign Permissions</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <p class="text-muted mb-4">Select the permissions you want to assign to this admin's role:</p>
                        <div id="permissionsContainer" class="row">
                            <div class="col-12 text-center p-4">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading permissions...</span>
                                </div>
                                <p class="mt-2 text-muted">Loading permissions...</p>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-sm btn-secondary px-3 py-2 small" data-bs-dismiss="modal" style="font-size: 0.75rem;">Cancel</button>
                        <button type="button" class="btn btn-sm btn-primary px-3 py-2 small" onclick="savePermissions()" style="font-size: 0.75rem;">Save Permissions</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Edit Admin Modal -->
        <div class="modal fade" id="editAdminModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Edit Admin</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="editAdminForm">
                            <div class="mb-3">
                                <label class="form-label">First Name</label>
                                <input type="text" class="form-control" id="editFirstName" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Last Name</label>
                                <input type="text" class="form-control" id="editLastName" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Email</label>
                                <input type="email" class="form-control" id="editEmail" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Status</label>
                                <select class="form-control" id="editStatus">
                                    <option value="true">Active</option>
                                    <option value="false">Inactive</option>
                                </select>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-sm btn-secondary px-3 py-2 small" data-bs-dismiss="modal" style="font-size: 0.75rem;">Cancel</button>
                        <button type="button" class="btn btn-sm btn-primary px-3 py-2 small" onclick="updateAdmin()" style="font-size: 0.75rem;">Update Admin</button>
                    </div>
                </div>
            </div>
        </div>

        <a href="#" class="back-to-top">
            <i class="icofont-simple-up"></i>
        </a>

    </div>

    <!-- jQuery from CDN with local fallback -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
    <script>
        // Fallback to local jQuery if CDN fails
        if (typeof jQuery === 'undefined') {
            document.write('<script src="assets/js/vendor/jquery-3.5.1.min.js"><\/script>');
        }
    </script>
    <!-- Bootstrap 5 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz" crossorigin="anonymous"></script>
    <script src="assets/js/vendor/modernizr-3.11.2.min.js"></script>
    <script src="assets/js/plugins.min.js"></script>
    <script src="assets/js/main.js"></script>
    <script src="assets/js/api.js"></script>
    <script src="assets/js/utils.js"></script>
    <script src="assets/js/role-access-control.js"></script>
    <script>
        // Authentication and role check - MUST BE FIRST
        (function() {
            // Wait for API to load
            if (typeof API === 'undefined') {
                setTimeout(arguments.callee, 100);
                return;
            }
            
            const token = API.config.getAuthToken();
            const user = API.config.getUser();
            
            // Check authentication
            if (!token || !user) {
                console.log('No token or user found, redirecting to login');
                window.location.href = 'login.html';
                return;
            }
            
            // Check for super_admin role
            let hasSuperAdminRole = false;
            
            if (user.roles && Array.isArray(user.roles)) {
                hasSuperAdminRole = user.roles.some(role => {
                    const roleName = (role.name || role).toLowerCase();
                    return roleName === 'super_admin';
                });
            } else if (user.role) {
                hasSuperAdminRole = user.role.toLowerCase() === 'super_admin';
            }
            
            if (!hasSuperAdminRole) {
                console.log('Super admin access required. Current user roles:', user.roles);
                alert('Access denied. Super Admin access required.');
                
                // Redirect based on user's actual role
                if (user.roles && Array.isArray(user.roles)) {
                    const roleNames = user.roles.map(r => (r.name || r).toLowerCase());
                    if (roleNames.includes('admin')) {
                        window.location.href = 'admin-dashboard.html';
                    } else {
                        window.location.href = 'index.html';
                    }
                } else {
                    window.location.href = 'index.html';
                }
                return;
            }
            
            console.log('Super admin access granted');
        })();
        
        // Set role on page load (after verification)
        const user = API.config.getUser();
        if (user && user.roles) {
            const roleNames = user.roles.map(r => (r.name || r).toLowerCase());
            if (roleNames.includes('super_admin')) {
                localStorage.setItem('userRole', 'super_admin');
            }
        }
        
        // Debug: Check if required libraries are loaded
        console.log('jQuery loaded:', typeof jQuery !== 'undefined');
        console.log('API loaded:', typeof API !== 'undefined');
        console.log('Bootstrap loaded:', typeof bootstrap !== 'undefined');
        
        let adminRoleId = null;
        let allPermissions = [];
        let allRoles = [];
        let currentEditingAdminId = null;
        let currentEditingRoleId = null;
        
        // Load admins from API
        async function loadAdmins() {
            try {
                if (typeof API === 'undefined') {
                    console.error('API not loaded');
                    return;
                }
                
                const response = await API.user.getAll();
                const tbody = $('#adminsTableBody');
                
                if (response.success && response.data && response.data.users) {
                    const users = response.data.users;
                    
                    // Filter to show only admins (users with admin role)
                    const admins = users.filter(user => {
                        if (user.roles && Array.isArray(user.roles)) {
                            return user.roles.some(role => role.name === 'admin' || role.name === 'super_admin');
                        }
                        return false;
                    });
                    
                    if (admins.length === 0) {
                        tbody.html('<tr><td colspan="6" class="text-center text-muted">No admins found. Create your first admin!</td></tr>');
                        return;
                    }
                    
                    let html = '';
                    admins.forEach(admin => {
                        const fullName = `${admin.firstName || ''} ${admin.lastName || ''}`.trim() || 'Unknown';
                        const roleNames = admin.roles ? admin.roles.map(r => r.name).join(', ') : 'No role';
                        const roleBadge = admin.roles && admin.roles.some(r => r.name === 'super_admin') 
                            ? '<span class="badge bg-danger">Super Admin</span>' 
                            : '<span class="badge bg-info">Admin</span>';
                        const permissionCount = admin.permissions ? admin.permissions.length : 0;
                        const status = admin.isActive ? '<span class="badge bg-success">Active</span>' : '<span class="badge bg-secondary">Inactive</span>';
                        
                        html += `
                            <tr data-admin-id="${admin.id}">
                                <td>
                                    <div class="d-flex align-items-center">
                                        <img src="${admin.profileImage || 'assets/images/author/author-09.jpg'}" class="rounded-circle me-2" width="40" height="40" alt="">
                                        <strong>${fullName}</strong>
                                    </div>
                                </td>
                                <td>${admin.email || 'N/A'}</td>
                                <td>${roleBadge}</td>
                                <td><span class="badge bg-secondary">${permissionCount} permissions</span></td>
                                <td>${status}</td>
                                <td>
                                    <button class="btn btn-sm btn-info px-2 py-1 small" onclick="openPermissionsModal(${admin.id})" data-admin-id="${admin.id}" data-permission="assign_permissions" style="font-size: 0.7rem;">
                                        <i class="icofont-settings me-1"></i> Permissions
                                    </button>
                                    <button class="btn btn-sm btn-warning px-2 py-1" onclick="openEditAdminModal(${admin.id})" data-admin-id="${admin.id}" data-permission="edit_admin" style="font-size: 0.7rem;">
                                        <i class="icofont-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-danger px-2 py-1" onclick="deleteAdmin(${admin.id})" data-admin-id="${admin.id}" data-permission="delete_admin" style="font-size: 0.7rem;">
                                        <i class="icofont-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        `;
                    });
                    
                    tbody.html(html);
                } else {
                    tbody.html('<tr><td colspan="6" class="text-center text-muted">Failed to load admins</td></tr>');
                }
            } catch (error) {
                console.error('Error loading admins:', error);
                $('#adminsTableBody').html('<tr><td colspan="6" class="text-center text-danger">Error loading admins. Please refresh the page.</td></tr>');
            }
        }
        
        // Load roles and permissions on page load
        async function loadRolesAndPermissions() {
            try {
                if (typeof API === 'undefined') {
                    console.error('API not loaded');
                    return;
                }
                
                // Load roles
                const rolesResponse = await API.role.getAll();
                if (rolesResponse.success && rolesResponse.data && rolesResponse.data.roles) {
                    allRoles = rolesResponse.data.roles;
                    const adminRole = allRoles.find(r => r.name === 'admin');
                    if (adminRole) {
                        adminRoleId = adminRole.id;
                    }
                }
                
                // Load permissions
                const permissionsResponse = await API.permission.getAll();
                if (permissionsResponse.success && permissionsResponse.data && permissionsResponse.data.permissions) {
                    allPermissions = permissionsResponse.data.permissions;
                }
            } catch (error) {
                console.error('Error loading roles and permissions:', error);
            }
        }
        
        // Render permissions in modal
        function renderPermissions(rolePermissions = []) {
            const container = $('#permissionsContainer');
            container.empty();
            
            if (allPermissions.length === 0) {
                container.html('<div class="col-12 text-center text-muted p-4">No permissions available</div>');
                return;
            }
            
            // Group permissions by category
            const categories = {
                'Course Management': ['create_course', 'edit_course', 'delete_course', 'view_course'],
                'User Management': ['create_user', 'edit_user', 'delete_user', 'view_user'],
                'Student Management': ['create_student', 'edit_student', 'delete_student', 'view_student', 'assign_student'],
                'Tutor Management': ['create_tutor', 'edit_tutor', 'delete_tutor', 'view_tutor', 'approve_tutor'],
                'Blog Management': ['create_blog', 'edit_blog', 'delete_blog', 'view_blog'],
                'Payment Management': ['view_payment', 'process_payment'],
                'Role & Permission Management': ['manage_roles', 'manage_permissions', 'assign_roles'],
                'Content Management': ['manage_content'],
                'Reports': ['view_reports']
            };
            
            const rolePermissionIds = rolePermissions.map(p => p.id || p);
            
            let html = '';
            Object.keys(categories).forEach(categoryName => {
                const categoryPerms = categories[categoryName];
                const matchingPerms = allPermissions.filter(p => categoryPerms.includes(p.name));
                
                if (matchingPerms.length > 0) {
                    html += `<div class="col-md-6 mb-4">`;
                    html += `<h6 class="mb-3">${categoryName}</h6>`;
                    
                    matchingPerms.forEach(permission => {
                        const isChecked = rolePermissionIds.includes(permission.id);
                        const permId = `perm_${permission.id}`;
                        const displayName = permission.name.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                        
                        html += `
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="${permId}" value="${permission.id}" ${isChecked ? 'checked' : ''}>
                                <label class="form-check-label" for="${permId}">${displayName}</label>
                            </div>
                        `;
                    });
                    
                    html += `</div>`;
                }
            });
            
            if (html === '') {
                html = '<div class="col-12 text-center text-muted p-4">No permissions available</div>';
            }
            
            container.html(html);
        }
        
        // Open permissions modal
        async function openPermissionsModal(adminId) {
            currentEditingAdminId = adminId;
            
            try {
                if (typeof API === 'undefined') {
                    showMessage('API not loaded. Please refresh the page.', 'error');
                    return;
                }
                
                // Get admin details
                const adminResponse = await API.user.getById(adminId);
                if (!adminResponse.success || !adminResponse.data || !adminResponse.data.user) {
                    showMessage('Failed to load admin details', 'error');
                    return;
                }
                
                const admin = adminResponse.data.user;
                const fullName = `${admin.firstName || ''} ${admin.lastName || ''}`.trim() || 'Unknown';
                $('#editPermissionsModalTitle').text(`Assign Permissions - ${fullName}`);
                
                // Get admin's role
                if (!admin.roles || admin.roles.length === 0) {
                    showMessage('Admin has no role assigned', 'error');
                    return;
                }
                
                // Use the first role (usually admin)
                const adminRole = admin.roles[0];
                currentEditingRoleId = adminRole.id;
                
                // Get role with permissions
                const roleResponse = await API.role.getById(adminRole.id);
                if (roleResponse.success && roleResponse.data && roleResponse.data.role) {
                    const role = roleResponse.data.role;
                    const rolePermissions = role.permissions || [];
                    renderPermissions(rolePermissions);
                } else {
                    renderPermissions([]);
                }
                
                $('#editPermissionsModal').modal('show');
            } catch (error) {
                console.error('Error opening permissions modal:', error);
                showMessage('Failed to load permissions. Please try again.', 'error');
            }
        }
        
        // Save permissions
        async function savePermissions() {
            if (!currentEditingRoleId) {
                showMessage('Role ID not found', 'error');
                return;
            }
            
            try {
                if (typeof API === 'undefined') {
                    showMessage('API not loaded. Please refresh the page.', 'error');
                    return;
                }
                
                // Get selected permission IDs
                const selectedPermissions = [];
                $('#permissionsContainer input[type="checkbox"]:checked').each(function() {
                    selectedPermissions.push(parseInt($(this).val()));
                });
                
                // Assign permissions to role
                const response = await API.role.assignPermissions(currentEditingRoleId, selectedPermissions);
                
                if (response.success) {
                    showMessage('Permissions assigned successfully!');
                    $('#editPermissionsModal').modal('hide');
                    // Reload admins to refresh permission counts
                    await loadAdmins();
                } else {
                    showMessage(response.message || 'Failed to assign permissions', 'error');
                }
            } catch (error) {
                console.error('Error saving permissions:', error);
                showMessage(error.message || 'Failed to save permissions. Please try again.', 'error');
            }
        }
        
        // Open edit admin modal
        async function openEditAdminModal(adminId) {
            currentEditingAdminId = adminId;
            
            try {
                if (typeof API === 'undefined') {
                    showMessage('API not loaded. Please refresh the page.', 'error');
                    return;
                }
                
                const response = await API.user.getById(adminId);
                if (response.success && response.data && response.data.user) {
                    const admin = response.data.user;
                    $('#editFirstName').val(admin.firstName || '');
                    $('#editLastName').val(admin.lastName || '');
                    $('#editEmail').val(admin.email || '');
                    $('#editStatus').val(admin.isActive ? 'true' : 'false');
                    $('#editAdminModal').modal('show');
                } else {
                    showMessage('Failed to load admin details', 'error');
                }
            } catch (error) {
                console.error('Error loading admin for edit:', error);
                showMessage('Failed to load admin details. Please try again.', 'error');
            }
        }
        
        // Update admin
        async function updateAdmin() {
            if (!currentEditingAdminId) {
                showMessage('Admin ID not found', 'error');
                return;
            }
            
            try {
                if (typeof API === 'undefined') {
                    showMessage('API not loaded. Please refresh the page.', 'error');
                    return;
                }
                
                const firstName = $('#editFirstName').val().trim();
                const lastName = $('#editLastName').val().trim();
                const email = $('#editEmail').val().trim();
                const isActive = $('#editStatus').val() === 'true';
                
                if (!firstName || !lastName || !email) {
                    showMessage('Please fill in all required fields', 'error');
                    return;
                }
                
                const userData = {
                    firstName,
                    lastName,
                    email,
                    isActive
                };
                
                const response = await API.user.update(currentEditingAdminId, userData);
                
                if (response.success) {
                    showMessage('Admin updated successfully!');
                    $('#editAdminModal').modal('hide');
                    await loadAdmins();
                } else {
                    showMessage(response.message || 'Failed to update admin', 'error');
                }
            } catch (error) {
                console.error('Error updating admin:', error);
                showMessage(error.message || 'Failed to update admin. Please try again.', 'error');
            }
        }
        
        // Set active menu item based on current page
        function setActiveMenuItem() {
            const currentPage = window.location.pathname.split('/').pop() || window.location.href.split('/').pop();
            $('.admin-tab-menu a').removeClass('active');
            $('.admin-tab-menu a').each(function() {
                const href = $(this).attr('href');
                if (href === currentPage || (currentPage === '' && href === 'super-admin-dashboard.html')) {
                    $(this).addClass('active');
                }
            });
        }

        // Load roles and permissions on page load
        $(document).ready(async function() {
            // Set active menu item
            setActiveMenuItem();
            
            await loadRolesAndPermissions();
            // Load admins
            loadAdmins();
            
            // Event handlers are now using onclick in the HTML, so these are not needed
            // But keeping for backward compatibility if any buttons still use data-bs-target
            $(document).on('click', '[data-bs-target="#editPermissionsModal"]', function() {
                const adminId = $(this).data('admin-id');
                if (adminId) {
                    openPermissionsModal(adminId);
                }
            });
            
            $(document).on('click', '[data-bs-target="#editAdminModal"]', function() {
                const adminId = $(this).data('admin-id');
                if (adminId) {
                    openEditAdminModal(adminId);
                }
            });
        });
        
        // Show success/error message
        function showMessage(message, type = 'success') {
            const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
            const messageHtml = `<div class="alert ${alertClass} alert-dismissible fade show" role="alert" style="position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 300px;">
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>`;
            $('body').append(messageHtml);
            setTimeout(() => $('.alert').fadeOut(), 5000);
        }
        
        async function createAdmin() {
            console.log('createAdmin() called');
            try {
                if (typeof API === 'undefined') {
                    showMessage('API not loaded. Please refresh the page.', 'error');
                    console.error('API is not defined');
                    return;
                }
                
                const form = $('#createAdminModal form');
                if (form.length === 0) {
                    showMessage('Form not found', 'error');
                    console.error('Form not found');
                    return;
                }
                const fullName = form.find('input[type="text"]').first().val();
                const email = form.find('input[type="email"]').val();
                const password = form.find('input[type="password"]').val();
                const roleName = form.find('select').val() || 'admin';
                
                if (!fullName || !email || !password) {
                    showMessage('Please fill in all required fields', 'error');
                    return;
                }
                
                // Split full name into first and last name
                const nameParts = fullName.trim().split(' ');
                const firstName = nameParts[0] || '';
                const lastName = nameParts.slice(1).join(' ') || '';
                
                // Get admin role ID if not already loaded
                if (!adminRoleId) {
                    try {
                        const rolesResponse = await API.role.getAll();
                        if (rolesResponse.success && rolesResponse.data && rolesResponse.data.roles) {
                            const adminRole = rolesResponse.data.roles.find(r => r.name === 'admin');
                            if (adminRole) {
                                adminRoleId = adminRole.id;
                            }
                        }
                    } catch (error) {
                        console.error('Error loading roles:', error);
                    }
                }
                
                if (!adminRoleId) {
                    showMessage('Could not find admin role. Please try again.', 'error');
                    return;
                }
                
                const userData = {
                    firstName: firstName,
                    lastName: lastName,
                    email: email.trim(),
                    password: password,
                    roleIds: [adminRoleId]
                };
                
                const response = await API.user.create(userData);
                
                if (response.success) {
                    showMessage('Admin created successfully!');
            $('#createAdminModal').modal('hide');
                    form[0].reset();
                    // Reload the table instead of full page reload
                    await loadAdmins();
                } else {
                    showMessage(response.message || 'Failed to create admin', 'error');
                }
            } catch (error) {
                console.error('Error creating admin:', error);
                showMessage(error.message || 'Failed to create admin. Please try again.', 'error');
            }
        }
        
        
        async function deleteAdmin(id) {
            console.log('deleteAdmin() called with id:', id);
            if (!confirm('Are you sure you want to delete this admin? This action cannot be undone.')) {
                return;
            }
            
            try {
                if (typeof API === 'undefined') {
                    showMessage('API not loaded. Please refresh the page.', 'error');
                    console.error('API is not defined');
                    return;
                }
                
                const response = await API.user.delete(id);
                
                if (response.success) {
                    showMessage('Admin deleted successfully!');
                    // Remove row from table immediately
                    $(`tr[data-admin-id="${id}"]`).fadeOut(300, function() {
                        $(this).remove();
                        // Reload if table is empty
                        if ($('#adminsTableBody tr').length === 0) {
                            loadAdmins();
                        }
                    });
                } else {
                    showMessage(response.message || 'Failed to delete admin', 'error');
                }
            } catch (error) {
                console.error('Error deleting admin:', error);
                showMessage(error.message || 'Failed to delete admin. Please try again.', 'error');
            }
        }
    </script>

</body>

</html>

 