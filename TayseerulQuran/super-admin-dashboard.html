<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <title>Super Admin Dashboard - TayseerulQuran</title>
    <meta name="robots" content="noindex, follow" />
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="shortcut icon" type="image/x-icon" href="assets/images/favicon.ico">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="assets/css/plugins/icofont.min.css">
    <link rel="stylesheet" href="assets/css/plugins/flaticon.css">
    <link rel="stylesheet" href="assets/css/plugins/font-awesome.min.css">
    <link rel="stylesheet" href="assets/css/plugins/animate.min.css">
    <link rel="stylesheet" href="assets/css/plugins/swiper-bundle.min.css">
    <link rel="stylesheet" href="assets/css/plugins/magnific-popup.css">
    <link rel="stylesheet" href="assets/css/plugins/nice-select.css">
    <link rel="stylesheet" href="assets/css/plugins/apexcharts.css">
    <link rel="stylesheet" href="assets/css/plugins/jqvmap.min.css">
    <link rel="stylesheet" href="assets/css/style.css">
    <style>
        /* Fix Admin Tab Menu on the left side */
        .admin-tab-menu {
            position: fixed;
            left: 80px;
            top: 80px;
            bottom: 0;
            width: 200px;
            background: #fff;
            padding: 20px 0;
            z-index: 100;
            overflow-y: auto;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }
        
        .page-content-wrapper {
            margin-left: 200px;
        }
        
        .main-content-wrapper {
            padding-left: 20px;
        }
        
        @media (max-width: 768px) {
            .admin-tab-menu {
                position: relative;
                left: 0;
                top: 0;
                width: 100%;
                margin-bottom: 20px;
            }
            
            .page-content-wrapper {
                margin-left: 0;
            }
        }
    </style>
</head>

<body>

    <div class="main-wrapper main-wrapper-02">

        <!-- Login Header Start -->
        <div class="section login-header">
            <div class="login-header-wrapper navbar navbar-expand">
                <div class="login-header-logo">
                    <a href="index.html"><img src="assets/images/logo-icon.png" alt="Logo"></a>
                </div>

                <div class="login-header-search dropdown">
                    <button class="search-toggle" data-bs-toggle="dropdown"><i class="flaticon-loupe"></i></button>
                    <div class="search-input dropdown-menu">
                        <form action="#">
                            <input type="text" placeholder="Search here">
                        </form>
                    </div>
                </div>

                <div class="login-header-action ml-auto">
                    <div class="dropdown">
                        <button class="action notification" data-bs-toggle="dropdown">
                            <i class="flaticon-notification"></i>
                            <span class="active"></span>
                        </button>
                        <div class="dropdown-menu dropdown-notification">
                            <ul class="notification-items-list">
                                <li class="notification-item">
                                    <span class="notify-icon bg-warning text-white"><i class="icofont-ui-user"></i></span>
                                    <div class="dropdown-body">
                                        <a href="super-admin-tutors.html">
                                            <p><strong>3</strong> new tutor applications pending approval</p>
                                        </a>
                                    </div>
                                    <span class="notify-time">2 min ago</span>
                                </li>
                                <li class="notification-item">
                                    <span class="notify-icon bg-success text-white"><i class="icofont-shopping-cart"></i></span>
                                    <div class="dropdown-body">
                                        <a href="super-admin-payments.html">
                                            <p><strong>5</strong> new payments received</p>
                                        </a>
                                    </div>
                                    <span class="notify-time">15 min ago</span>
                                </li>
                            </ul>
                            <a class="all-notification" href="#">See all notifications <i class="icofont-simple-right"></i></a>
                        </div>
                    </div>

                    <a class="action author" href="#">
                        <img src="assets/images/author/author-07.jpg" alt="Author">
                    </a>

                    <div class="dropdown">
                        <button class="action more" data-bs-toggle="dropdown">
                            <span></span>
                            <span></span>
                            <span></span>
                        </button>
                        <ul class="dropdown-menu">
                            <li><a href="#"><i class="icofont-user"></i> Profile</a></li>
                            <li><a href="#"><i class="icofont-settings"></i> Settings</a></li>
                            <li><a href="login.html"><i class="icofont-logout"></i> Sign Out</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        <!-- Login Header End -->

        <!-- Super Admin Dashboard Start -->
        <div class="section overflow-hidden position-relative" id="wrapper">
            <!-- Sidebar Wrapper Start -->
            <div class="sidebar-wrapper">
                <div class="menu-list">
                    <a class="active" href="super-admin-dashboard.html" title="Dashboard"><img src="assets/images/menu-icon/icon-3.png" alt="Icon"></a>
                    <a href="super-admin-courses.html" title="Courses" data-permission="view_courses"><img src="assets/images/menu-icon/icon-1.png" alt="Icon"></a>
                    <a href="super-admin-students.html" title="Students" data-permission="view_students"><img src="assets/images/menu-icon/icon-2.png" alt="Icon"></a>
                    <a href="super-admin-tutors.html" title="Tutors" data-permission="view_tutors"><img src="assets/images/menu-icon/icon-4.png" alt="Icon"></a>
                    <a href="super-admin-payments.html" title="Payments" data-permission="view_payments"><img src="assets/images/menu-icon/icon-5.png" alt="Icon"></a>
                    <a href="super-admin-roles.html" title="Admin Roles" data-role="super_admin"><img src="assets/images/menu-icon/icon-1.png" alt="Icon"></a>
                    <a href="super-admin-blog.html" title="Blog" data-permission="view_blog_posts"><img src="assets/images/menu-icon/icon-2.png" alt="Icon"></a>
                </div>
            </div>
            <!-- Sidebar Wrapper End -->

            <div class="page-content-wrapper py-0">
                <!-- Admin Tab Menu Start -->
                <div class="nav flex-column nav-pills admin-tab-menu">
                    <a href="super-admin-dashboard.html" class="active">Dashboard</a>
                    <a href="super-admin-courses.html" data-permission="view_courses">Courses</a>
                    <a href="super-admin-students.html" data-permission="view_students">Students</a>
                    <a href="super-admin-tutors.html" data-permission="view_tutors">Tutors</a>
                    <a href="super-admin-payments.html" data-permission="view_payments">Payments</a>
                    <a href="super-admin-roles.html" data-role="super_admin">Admin Roles</a>
                    <a href="super-admin-blog.html" data-permission="view_blog_posts">Blog</a>
                </div>
                <!-- Admin Tab Menu End -->

                <!-- Page Content Wrapper Start -->
                <div class="main-content-wrapper">
                    <div class="container-fluid">
                        <!-- Dashboard Header -->
                        <div class="admin-top-bar flex-wrap mb-4">
                            <div>
                                <h3 class="title mb-2">Super Admin Dashboard</h3>
                                <p class="text-muted">Welcome back! Here's what's happening with your platform.</p>
                            </div>
                            <div class="badge bg-primary p-2" id="current-role">SUPER ADMIN</div>
                        </div>

                        <!-- Stats Cards Start -->
                        <div class="row mb-4">
                            <div class="col-xl-3 col-md-6 mb-4">
                                <div class="card border-0 shadow-sm">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <h6 class="text-muted mb-2">Total Courses</h6>
                                                <h3 class="mb-0" id="totalCourses">-</h3>
                                                <small class="text-success"><i class="icofont-arrow-up"></i> 12% from last month</small>
                                            </div>
                                            <div class="bg-primary bg-opacity-10 rounded-circle p-3">
                                                <i class="flaticon-book text-primary" style="font-size: 2rem;"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="col-xl-3 col-md-6 mb-4">
                                <div class="card border-0 shadow-sm">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <h6 class="text-muted mb-2">Total Students</h6>
                                                <h3 class="mb-0" id="totalStudents">-</h3>
                                                <small class="text-success"><i class="icofont-arrow-up"></i> 8% from last month</small>
                                            </div>
                                            <div class="bg-success bg-opacity-10 rounded-circle p-3">
                                                <i class="flaticon-user text-success" style="font-size: 2rem;"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="col-xl-3 col-md-6 mb-4">
                                <div class="card border-0 shadow-sm">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <h6 class="text-muted mb-2">Pending Tutors</h6>
                                                <h3 class="mb-0" id="pendingTutors">-</h3>
                                                <small class="text-warning"><i class="icofont-warning"></i> Need approval</small>
                                            </div>
                                            <div class="bg-warning bg-opacity-10 rounded-circle p-3">
                                                <i class="flaticon-teacher text-warning" style="font-size: 2rem;"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="col-xl-3 col-md-6 mb-4">
                                <div class="card border-0 shadow-sm">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <h6 class="text-muted mb-2">Total Revenue</h6>
                                                <h3 class="mb-0" id="totalRevenue">-</h3>
                                                <small class="text-success"><i class="icofont-arrow-up"></i> 15% from last month</small>
                                            </div>
                                            <div class="bg-info bg-opacity-10 rounded-circle p-3">
                                                <i class="flaticon-money text-info" style="font-size: 2rem;"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Additional Stats Row -->
                        <div class="row mb-4">
                            <div class="col-xl-3 col-md-6 mb-4">
                                <div class="card border-0 shadow-sm">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <h6 class="text-muted mb-2">Total Enrollments</h6>
                                                <h3 class="mb-0" id="totalEnrollments">-</h3>
                                                <small class="text-info"><i class="icofont-users"></i> All time</small>
                                            </div>
                                            <div class="bg-primary bg-opacity-10 rounded-circle p-3">
                                                <i class="flaticon-user text-primary" style="font-size: 2rem;"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="col-xl-3 col-md-6 mb-4">
                                <div class="card border-0 shadow-sm">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <h6 class="text-muted mb-2">Active Enrollments</h6>
                                                <h3 class="mb-0" id="activeEnrollments">-</h3>
                                                <small class="text-success"><i class="icofont-check"></i> Currently enrolled</small>
                                            </div>
                                            <div class="bg-success bg-opacity-10 rounded-circle p-3">
                                                <i class="flaticon-check text-success" style="font-size: 2rem;"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="col-xl-3 col-md-6 mb-4">
                                <div class="card border-0 shadow-sm">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <h6 class="text-muted mb-2">Completed Courses</h6>
                                                <h3 class="mb-0" id="completedEnrollments">-</h3>
                                                <small class="text-success"><i class="icofont-trophy"></i> Finished</small>
                                            </div>
                                            <div class="bg-warning bg-opacity-10 rounded-circle p-3">
                                                <i class="flaticon-trophy text-warning" style="font-size: 2rem;"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="col-xl-3 col-md-6 mb-4">
                                <div class="card border-0 shadow-sm">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <h6 class="text-muted mb-2">Completion Rate</h6>
                                                <h3 class="mb-0" id="completionRate">-</h3>
                                                <small class="text-info"><i class="icofont-chart-line"></i> Success rate</small>
                                            </div>
                                            <div class="bg-info bg-opacity-10 rounded-circle p-3">
                                                <i class="flaticon-chart text-info" style="font-size: 2rem;"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Stats Cards End -->

                        <!-- Quick Actions Start -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <div class="card border-0 shadow-sm">
                                    <div class="card-header bg-white border-0 py-3">
                                        <h5 class="mb-0">Quick Actions</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-3 mb-3">
                                                <a href="super-admin-courses.html?action=add" class="btn btn-sm btn-primary w-100 px-3 py-2 small" data-permission="add_course" style="font-size: 0.75rem;">
                                                    <i class="icofont-plus me-1"></i> Add New Course
                                                </a>
                                            </div>
                                            <div class="col-md-3 mb-3">
                                                <a href="super-admin-tutors.html" class="btn btn-sm btn-warning w-100 px-3 py-2 small" data-permission="approve_tutor" style="font-size: 0.75rem;">
                                                    <i class="icofont-check me-1"></i> Approve Tutors
                                                </a>
                                            </div>
                                            <div class="col-md-3 mb-3">
                                                <a href="super-admin-roles.html" class="btn btn-sm btn-info w-100 px-3 py-2 small" data-role="super_admin" style="font-size: 0.75rem;">
                                                    <i class="icofont-users me-1"></i> Manage Admin Roles
                                                </a>
                                            </div>
                                            <div class="col-md-3 mb-3">
                                                <a href="super-admin-blog.html?action=add" class="btn btn-sm btn-success w-100 px-3 py-2 small" data-permission="create_blog_post" style="font-size: 0.75rem;">
                                                    <i class="icofont-edit me-1"></i> Create Blog Post
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Quick Actions End -->

                        <!-- Recent Activity Start -->
                        <div class="row">
                            <div class="col-lg-6 mb-4">
                                <div class="card border-0 shadow-sm">
                                    <div class="card-header bg-white border-0 py-3">
                                        <h5 class="mb-0">Recent Payments</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="table-responsive">
                                            <table class="table table-hover">
                                                <thead>
                                                    <tr>
                                                        <th>Student</th>
                                                        <th>Course</th>
                                                        <th>Amount</th>
                                                        <th>Date</th>
                                                        <th>Status</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="recentPaymentsBody">
                                                    <tr>
                                                        <td colspan="5" class="text-center">
                                                            <div class="spinner-border text-primary" role="status">
                                                                <span class="visually-hidden">Loading...</span>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                        <a href="super-admin-payments.html" class="btn btn-link p-0 mt-2" data-permission="view_payments">View All Payments →</a>
                                    </div>
                                </div>
                            </div>

                            <div class="col-lg-6 mb-4">
                                <div class="card border-0 shadow-sm">
                                    <div class="card-header bg-white border-0 py-3">
                                        <h5 class="mb-0">Recent Enrollments</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="table-responsive">
                                            <table class="table table-hover">
                                                <thead>
                                                    <tr>
                                                        <th>Student</th>
                                                        <th>Course</th>
                                                        <th>Date</th>
                                                        <th>Status</th>
                                                        <th>Progress</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="recentEnrollmentsBody">
                                                    <tr>
                                                        <td colspan="5" class="text-center">
                                                            <div class="spinner-border text-primary" role="status">
                                                                <span class="visually-hidden">Loading...</span>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                        <a href="super-admin-students.html" class="btn btn-link p-0 mt-2" data-permission="view_students">View All Enrollments →</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-lg-4 mb-4">
                                <div class="card border-0 shadow-sm">
                                    <div class="card-header bg-white border-0 py-3">
                                        <h5 class="mb-0">Pending Approvals</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="list-group list-group-flush">
                                            <div class="list-group-item border-0 px-0">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <div>
                                                        <h6 class="mb-1">Sarah Williams</h6>
                                                        <small class="text-muted">Applied for Tutor</small>
                                                    </div>
                                                    <a href="super-admin-tutors.html" class="btn btn-sm btn-warning" data-permission="approve_tutor">Review</a>
                                                </div>
                                            </div>
                                            <div class="list-group-item border-0 px-0">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <div>
                                                        <h6 class="mb-1">David Brown</h6>
                                                        <small class="text-muted">Applied for Tutor</small>
                                                    </div>
                                                    <a href="super-admin-tutors.html" class="btn btn-sm btn-warning" data-permission="approve_tutor">Review</a>
                                                </div>
                                            </div>
                                            <div class="list-group-item border-0 px-0">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <div>
                                                        <h6 class="mb-1">Emily Davis</h6>
                                                        <small class="text-muted">Applied for Tutor</small>
                                                    </div>
                                                    <a href="super-admin-tutors.html" class="btn btn-sm btn-warning" data-permission="approve_tutor">Review</a>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Recent Activity End -->

                    </div>
                </div>
                <!-- Page Content Wrapper End -->

            </div>

        </div>
        <!-- Super Admin Dashboard End -->

        <!-- Footer Start -->
        <div class="section footer-section">
            <div class="footer-copyright">
                <div class="container">
                    <div class="copyright-wrapper">
                        <div class="copyright-text">
                            <p>&copy; 2024 <span> TayseerulQuran </span> Super Admin Dashboard</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Footer End -->

        <a href="#" class="back-to-top">
            <i class="icofont-simple-up"></i>
        </a>

    </div>

    <!-- jQuery from CDN -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
    <script>
        // Ensure jQuery is loaded before other scripts
        if (typeof jQuery === 'undefined') {
            console.error('jQuery failed to load from CDN, trying local fallback...');
            const script = document.createElement('script');
            script.src = 'assets/js/vendor/jquery-3.5.1.min.js';
            script.onerror = function() {
                console.error('jQuery local fallback also failed');
            };
            document.head.appendChild(script);
        }
    </script>
    <!-- Bootstrap 5 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz" crossorigin="anonymous"></script>
    <script src="assets/js/vendor/modernizr-3.11.2.min.js"></script>
    <!-- Load plugins.min.js only if it exists, don't fail if missing -->
    <script>
        // Try to load plugins.min.js, but don't fail if it doesn't exist
        const pluginsScript = document.createElement('script');
        pluginsScript.src = 'assets/js/plugins.min.js';
        pluginsScript.onerror = function() {
            console.warn('plugins.min.js not found, continuing without it');
        };
        document.head.appendChild(pluginsScript);
    </script>
    <script src="assets/js/main.js"></script>
    <script src="assets/js/api.js"></script>
    <script src="assets/js/utils.js"></script>
    <script src="assets/js/role-access-control.js"></script>
    <script>
        // Authentication and role check
        (function() {
            // Wait for API to load
            if (typeof API === 'undefined') {
                setTimeout(arguments.callee, 100);
                return;
            }
            
            const token = API.config.getAuthToken();
            const user = API.config.getUser();
            
            // Check authentication
            if (!token || !user) {
                console.log('No token or user found, redirecting to login');
                window.location.href = 'login.html';
                return;
            }
            
            // Check role - handle multiple formats
            let hasSuperAdminRole = false;
            let hasAdminRole = false;
            
            if (user.roles && Array.isArray(user.roles)) {
                user.roles.forEach(role => {
                    const roleName = (role.name || role).toLowerCase();
                    if (roleName === 'super_admin') {
                        hasSuperAdminRole = true;
                    }
                    if (roleName === 'admin') {
                        hasAdminRole = true;
                    }
                });
            } else if (user.role) {
                // Handle single role string
                const roleName = user.role.toLowerCase();
                if (roleName === 'super_admin') {
                    hasSuperAdminRole = true;
                }
                if (roleName === 'admin') {
                    hasAdminRole = true;
                }
            }
            
            console.log('User roles:', user.roles);
            console.log('Has super_admin:', hasSuperAdminRole);
            console.log('Has admin:', hasAdminRole);
            
            // Redirect based on role
            if (!hasSuperAdminRole) {
                if (hasAdminRole) {
                    console.log('Admin user detected, redirecting to admin-dashboard.html');
                    window.location.href = 'admin-dashboard.html';
                } else {
                    console.log('No super_admin or admin role, redirecting to login');
                window.location.href = 'login.html';
                }
                return;
            }
            
            console.log('Super admin access granted');
        })();
        
        // Set role on page load (after verification)
        const user = API.config.getUser();
        if (user && user.roles) {
            const roleNames = user.roles.map(r => (r.name || r).toLowerCase());
            if (roleNames.includes('super_admin')) {
        localStorage.setItem('userRole', 'super_admin');
            }
        }
        
        // Show success/error message
        function showMessage(message, type = 'success') {
            const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
            const messageHtml = `<div class="alert ${alertClass} alert-dismissible fade show" role="alert" style="position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 300px;">
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>`;
            $('body').append(messageHtml);
            setTimeout(() => $('.alert').fadeOut(), 5000);
        }
        
        // Load dashboard statistics
        async function loadDashboardStats() {
            try {
                if (typeof API === 'undefined') {
                    console.error('API not loaded');
                    return;
                }
                
                console.log('Loading dashboard statistics...');
                
                // Load courses
                try {
                    const coursesResponse = await API.course.getAll();
                    if (coursesResponse.success && coursesResponse.data) {
                        const courses = Array.isArray(coursesResponse.data) ? coursesResponse.data : (coursesResponse.data.courses || []);
                        $('#totalCourses').text(courses.length || 0);
                    }
                } catch (error) {
                    console.error('Error loading courses:', error);
                    $('#totalCourses').text('0');
                }
                
                // Load students
                try {
                    const studentsResponse = await API.student.getAll();
                    if (studentsResponse.success && studentsResponse.data) {
                        const students = Array.isArray(studentsResponse.data) ? studentsResponse.data : (studentsResponse.data.students || []);
                        $('#totalStudents').text(students.length || 0);
                    }
                } catch (error) {
                    console.error('Error loading students:', error);
                    $('#totalStudents').text('0');
                }
                
                // Load tutors
                try {
                    const tutorsResponse = await API.tutor.getAll();
                    if (tutorsResponse.success && tutorsResponse.data) {
                        const tutors = Array.isArray(tutorsResponse.data) ? tutorsResponse.data : (tutorsResponse.data.tutors || []);
                        // Count pending tutors (assuming isApproved field)
                        const pendingTutors = tutors.filter(t => !t.isApproved).length;
                        $('#pendingTutors').text(pendingTutors || 0);
                    }
                } catch (error) {
                    console.error('Error loading tutors:', error);
                    $('#pendingTutors').text('0');
                }
                
                // Load payments/revenue
                try {
                    if (API.payment) {
                        const paymentsResponse = await API.payment.getAll({ limit: 1000 }); // Get all payments for revenue calculation
                        if (paymentsResponse.success && paymentsResponse.data) {
                            const payments = paymentsResponse.data.payments || [];
                            const totalRevenue = payments
                                .filter(p => p.status === 'completed' || p.status === 'paid')
                                .reduce((sum, p) => sum + (parseFloat(p.amount) || 0), 0);
                            $('#totalRevenue').text('$' + totalRevenue.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }));
                        } else {
                            $('#totalRevenue').text('$0');
                        }
                    } else {
                        $('#totalRevenue').text('$0');
                    }
                } catch (error) {
                    console.error('Error loading revenue:', error);
                    $('#totalRevenue').text('$0');
                }
                
                // Load enrollment statistics
                try {
                    if (API.enrollment) {
                        const enrollmentsResponse = await API.enrollment.getAll({ limit: 10000 }); // Get all enrollments
                        if (enrollmentsResponse.success && enrollmentsResponse.data) {
                            const enrollments = enrollmentsResponse.data.enrollments || [];
                            const totalEnrollments = enrollments.length;
                            const activeEnrollments = enrollments.filter(e => e.status === 'enrolled' || e.status === 'active').length;
                            const completedEnrollments = enrollments.filter(e => e.status === 'completed').length;
                            const completionRate = totalEnrollments > 0 ? ((completedEnrollments / totalEnrollments) * 100).toFixed(1) : 0;
                            
                            $('#totalEnrollments').text(totalEnrollments || 0);
                            $('#activeEnrollments').text(activeEnrollments || 0);
                            $('#completedEnrollments').text(completedEnrollments || 0);
                            $('#completionRate').text(completionRate + '%');
                        } else {
                            $('#totalEnrollments').text('0');
                            $('#activeEnrollments').text('0');
                            $('#completedEnrollments').text('0');
                            $('#completionRate').text('0%');
                        }
                    } else {
                        $('#totalEnrollments').text('0');
                        $('#activeEnrollments').text('0');
                        $('#completedEnrollments').text('0');
                        $('#completionRate').text('0%');
                    }
                } catch (error) {
                    console.error('Error loading enrollment stats:', error);
                    $('#totalEnrollments').text('0');
                    $('#activeEnrollments').text('0');
                    $('#completedEnrollments').text('0');
                    $('#completionRate').text('0%');
                }
                
            } catch (error) {
                console.error('Error loading dashboard stats:', error);
            }
        }
        
        // Load recent payments
        async function loadRecentPayments() {
            try {
                if (typeof API === 'undefined' || !API.payment) {
                    console.error('API or payment API not loaded');
                    $('#recentPaymentsBody').html('<tr><td colspan="5" class="text-center text-muted">Payment API not available</td></tr>');
                    return;
                }
                
                console.log('Loading recent payments...');
                const response = await API.payment.getAll({ limit: 5 });
                const tbody = $('#recentPaymentsBody');
                
                if (response.success && response.data && response.data.payments) {
                    const payments = response.data.payments;
                    
                    if (payments.length === 0) {
                        tbody.html('<tr><td colspan="5" class="text-center text-muted">No payments found</td></tr>');
                        return;
                    }
                    
                    let html = '';
                    payments.forEach(payment => {
                        const studentName = payment.user ? `${payment.user.firstName} ${payment.user.lastName}` : 'Unknown';
                        const courseName = payment.course ? payment.course.title : 'Unknown Course';
                        const amount = parseFloat(payment.amount || 0).toLocaleString('en-US', { style: 'currency', currency: 'USD' });
                        const date = payment.createdAt ? new Date(payment.createdAt).toLocaleDateString() : 'N/A';
                        const statusClass = payment.status === 'completed' || payment.status === 'paid' ? 'success' : 
                                          payment.status === 'pending' ? 'warning' : 'danger';
                        const statusText = payment.status ? payment.status.charAt(0).toUpperCase() + payment.status.slice(1) : 'Unknown';
                        
                        html += `
                            <tr>
                                <td>${studentName}</td>
                                <td>${courseName}</td>
                                <td>${amount}</td>
                                <td>${date}</td>
                                <td><span class="badge bg-${statusClass}">${statusText}</span></td>
                            </tr>
                        `;
                    });
                    
                    tbody.html(html);
                } else {
                    tbody.html('<tr><td colspan="5" class="text-center text-muted">No payments found</td></tr>');
                }
            } catch (error) {
                console.error('Error loading recent payments:', error);
                $('#recentPaymentsBody').html(`<tr><td colspan="5" class="text-center text-danger">Error loading payments: ${error.message || 'Unknown error'}</td></tr>`);
            }
        }
        
        // Load recent enrollments
        async function loadRecentEnrollments() {
            try {
                if (typeof API === 'undefined' || !API.enrollment) {
                    console.error('API or enrollment API not loaded');
                    $('#recentEnrollmentsBody').html('<tr><td colspan="5" class="text-center text-muted">Enrollment API not available</td></tr>');
                    return;
                }
                
                console.log('Loading recent enrollments...');
                const response = await API.enrollment.getAll({ limit: 5 });
                const tbody = $('#recentEnrollmentsBody');
                
                if (response.success && response.data && response.data.enrollments) {
                    const enrollments = response.data.enrollments;
                    
                    if (enrollments.length === 0) {
                        tbody.html('<tr><td colspan="5" class="text-center text-muted">No enrollments found</td></tr>');
                        return;
                    }
                    
                    let html = '';
                    enrollments.forEach(enrollment => {
                        const studentName = enrollment.student ? `${enrollment.student.firstName || ''} ${enrollment.student.lastName || ''}`.trim() : 
                                           enrollment.User ? `${enrollment.User.firstName || ''} ${enrollment.User.lastName || ''}`.trim() : 'Unknown';
                        const courseName = enrollment.Course ? enrollment.Course.title : enrollment.course ? enrollment.course.title : 'Unknown Course';
                        const date = enrollment.enrollmentDate ? new Date(enrollment.enrollmentDate).toLocaleDateString() : 
                                    enrollment.createdAt ? new Date(enrollment.createdAt).toLocaleDateString() : 'N/A';
                        const statusClass = enrollment.status === 'completed' ? 'success' : 
                                          enrollment.status === 'enrolled' || enrollment.status === 'active' ? 'primary' : 
                                          enrollment.status === 'dropped' ? 'danger' : 'secondary';
                        const statusText = enrollment.status ? enrollment.status.charAt(0).toUpperCase() + enrollment.status.slice(1) : 'Unknown';
                        const progress = enrollment.progress !== undefined ? enrollment.progress : 0;
                        
                        html += `
                            <tr>
                                <td>${studentName || 'Unknown'}</td>
                                <td>${courseName}</td>
                                <td>${date}</td>
                                <td><span class="badge bg-${statusClass}">${statusText}</span></td>
                                <td><small>${progress}%</small></td>
                            </tr>
                        `;
                    });
                    
                    tbody.html(html);
                } else {
                    tbody.html('<tr><td colspan="5" class="text-center text-muted">No enrollments found</td></tr>');
                }
            } catch (error) {
                console.error('Error loading recent enrollments:', error);
                $('#recentEnrollmentsBody').html(`<tr><td colspan="5" class="text-center text-danger">Error loading enrollments: ${error.message || 'Unknown error'}</td></tr>`);
            }
        }
        
        // Load stats and payments on page load
        $(document).ready(function() {
            // Wait for jQuery to be fully loaded
            if (typeof jQuery === 'undefined') {
                console.error('jQuery not loaded, retrying...');
                setTimeout(function() {
                    if (typeof jQuery !== 'undefined') {
                        loadDashboardStats();
                        loadRecentPayments();
                        loadRecentEnrollments();
                    } else {
                        console.error('jQuery still not loaded after retry');
                    }
                }, 1000);
            } else {
                loadDashboardStats();
                loadRecentPayments();
                loadRecentEnrollments();
            }
        });
    </script>

</body>

</html>

