<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <title>Blog Management - Super Admin</title>
    <meta name="robots" content="noindex, follow" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="shortcut icon" type="image/x-icon" href="assets/images/favicon.ico">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="assets/css/plugins/icofont.min.css">
    <link rel="stylesheet" href="assets/css/plugins/flaticon.css">
    <link rel="stylesheet" href="assets/css/plugins/font-awesome.min.css">
    <link rel="stylesheet" href="assets/css/plugins/animate.min.css">
    <link rel="stylesheet" href="assets/css/plugins/swiper-bundle.min.css">
    <link rel="stylesheet" href="assets/css/plugins/magnific-popup.css">
    <link rel="stylesheet" href="assets/css/plugins/nice-select.css">
    <link rel="stylesheet" href="assets/css/style.css">
    <style>
        /* Admin Tab Menu as Main Sidebar */
        .admin-tab-menu {
            position: fixed;
            left: 0;
            top: 80px;
            bottom: 0;
            width: 350px;
            background: #fff;
            padding: 20px ;
            z-index: 100;
            overflow-y: auto;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            border-right: 1px solid #e9ecef;
        }
        
        .admin-tab-menu a {
            display: block;
            padding: 12px 25px;
            color: #495057;
            text-decoration: none;
            border-left: 3px solid transparent;
            transition: all 0.3s ease;
            font-weight: 500;
            font-size: 14px;
        }
        
        .admin-tab-menu a:hover {
            background-color: #f8f9fa;
            color: #007bff;
            border-left-color: #007bff;
        }
        
        .admin-tab-menu a.active {
            background-color: #e7f3ff;
            color: #007bff;
            border-left-color: #007bff;
            font-weight: 600;
        }
        
        .page-content-wrapper {
            margin-left: 250px;
        }
        
        .main-content-wrapper {
            padding: 20px;
        }
        
        @media (max-width: 768px) {
            .admin-tab-menu {
                position: relative;
                left: 0;
                top: 0;
                width: 100%;
                margin-bottom: 20px;
                max-height: 300px;
            }
            
            .page-content-wrapper {
                margin-left: 0;
            }
        }
    </style>
</head>

<body>

    <div class="main-wrapper main-wrapper-02">

        <!-- Login Header Start -->
        <div class="section login-header">
            <div class="login-header-wrapper navbar navbar-expand">
                <div class="login-header-logo">
                    <a href="super-admin-dashboard.html"><img src="assets/images/logo-icon.png" alt="Logo"></a>
                </div>
                <div class="login-header-action ml-auto d-flex align-items-center gap-3">
                    <a class="action author" href="#">
                        <img src="assets/images/author/author-01.jpg" alt="Author" onerror="this.src='assets/images/logo-icon.png'">
                    </a>
                    <button class="btn btn-sm px-3 py-2" onclick="handleLogout()" style="font-size: 0.75rem; background-color: #dc3545; color: #fff; border: none;">
                        <i class="icofont-logout me-1"></i> Logout
                    </button>
                    <div class="dropdown">
                        <button class="action more" data-bs-toggle="dropdown">
                            <span></span>
                            <span></span>
                            <span></span>
                        </button>
                        <ul class="dropdown-menu">
                            <li><a href="super-admin-dashboard.html"><i class="icofont-home"></i> Dashboard</a></li>
                            <li><a href="#" onclick="handleLogout(); return false;"><i class="icofont-logout"></i> Sign Out</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Blog Admin Start -->
        <div class="section overflow-hidden position-relative" id="wrapper">
            <div class="page-content-wrapper py-0">
                <!-- Admin Tab Menu Start - Main Sidebar -->
                <div class="nav flex-column nav-pills admin-tab-menu">
                    <a href="super-admin-dashboard.html">Dashboard</a>
                    <a href="super-admin-courses.html" data-permission="view_courses">Courses</a>
                    <a href="super-admin-students.html" data-permission="view_students">Students</a>
                    <a href="super-admin-tutors.html" data-permission="view_tutors">Tutors</a>
                    <a href="super-admin-payments.html" data-permission="view_payments">Payments</a>
                    <a href="super-admin-roles.html" data-role="super_admin">Admin Roles</a>
                    <a href="super-admin-blog.html" data-permission="view_blog_posts">Blog</a>
                </div>
                <!-- Admin Tab Menu End -->

                <div class="main-content-wrapper">
                    <div class="container-fluid">
                        <div class="admin-top-bar flex-wrap mb-4">
                            <div>
                                <h3 class="title mb-2">Blog Management</h3>
                                <p class="text-muted">Create, edit, and manage blog posts</p>
                            </div>
                            <button class="btn btn-sm btn-primary px-3 py-2 small" data-bs-toggle="modal" data-bs-target="#createPostModal" data-permission="create_blog_post" style="font-size: 0.75rem;">
                                <i class="icofont-plus me-1"></i> Create New Post
                            </button>
                        </div>

                        <!-- Blog Posts Table -->
                        <div class="card border-0 shadow-sm">
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>Title</th>
                                                <th>Author</th>
                                                <th>Category</th>
                                                <th>Published Date</th>
                                                <th>Views</th>
                                                <th>Status</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="blogPostsTableBody">
                                            <tr>
                                                <td colspan="7" class="text-center">
                                                    <div class="spinner-border text-primary" role="status">
                                                        <span class="visually-hidden">Loading...</span>
                                                    </div>
                                                </td>
                                            </tr>
                                        </tbody>
                                                              
                                           
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Create Post Modal -->
        <div class="modal fade" id="createPostModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Create New Blog Post</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="createPostForm">
                            <div class="mb-3">
                                <label class="form-label">Post Title <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="addPostTitle" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Category <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="addPostCategory" list="blogCategoryList" placeholder="Type or select a category" required>
                                <datalist id="blogCategoryList">
                                    <!-- Categories will be populated dynamically -->
                                </datalist>
                                <small class="text-muted">Type a new category or select from existing ones</small>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Featured Image URL</label>
                                <div class="row align-items-center">
                                    <div class="col-md-8">
                                        <input type="url" class="form-control" id="addPostImage" placeholder="https://example.com/image.jpg">
                                        <small class="text-muted">Paste an image URL (optional)</small>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="image-preview-container" style="width: 100%; height: 80px; border: 2px dashed #ddd; border-radius: 8px; display: flex; align-items: center; justify-content: center; overflow: hidden; background: #f8f9fa;">
                                            <img id="addPostImagePreview" src="" alt="Preview" style="max-width: 100%; max-height: 100%; display: none; object-fit: cover;">
                                            <span id="addPostImagePlaceholder" class="text-muted text-center" style="font-size: 0.7rem;"><i class="icofont-image" style="font-size: 1.5rem; display: block;"></i>Preview</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Content <span class="text-danger">*</span></label>
                                <textarea class="form-control" id="addPostContent" rows="10" required placeholder="Write your blog post content here..."></textarea>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Tags</label>
                                <input type="text" class="form-control" id="addPostTags" placeholder="Separate tags with commas (e.g., quran, learning, tips)">
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-sm btn-secondary px-3 py-2 small" data-bs-dismiss="modal" style="font-size: 0.75rem;">Save as Draft</button>
                        <button type="button" class="btn btn-sm btn-primary px-3 py-2 small" onclick="savePost()" style="font-size: 0.75rem;">Publish Post</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Edit Post Modal -->
        <div class="modal fade" id="editPostModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Edit Blog Post</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="editPostForm">
                            <div class="mb-3">
                                <label class="form-label">Post Title <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="editPostTitle" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Category <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="editPostCategory" list="blogCategoryListEdit" placeholder="Type or select a category" required>
                                <datalist id="blogCategoryListEdit">
                                    <!-- Categories will be populated dynamically -->
                                </datalist>
                                <small class="text-muted">Type a new category or select from existing ones</small>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Featured Image URL</label>
                                <div class="row align-items-center">
                                    <div class="col-md-8">
                                        <input type="url" class="form-control" id="editPostImage" placeholder="https://example.com/image.jpg">
                                        <small class="text-muted">Paste an image URL (optional)</small>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="image-preview-container" style="width: 100%; height: 80px; border: 2px dashed #ddd; border-radius: 8px; display: flex; align-items: center; justify-content: center; overflow: hidden; background: #f8f9fa;">
                                            <img id="editPostImagePreview" src="" alt="Preview" style="max-width: 100%; max-height: 100%; display: none; object-fit: cover;">
                                            <span id="editPostImagePlaceholder" class="text-muted text-center" style="font-size: 0.7rem;"><i class="icofont-image" style="font-size: 1.5rem; display: block;"></i>Preview</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Content <span class="text-danger">*</span></label>
                                <textarea class="form-control" id="editPostContent" rows="10" required></textarea>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Tags</label>
                                <input type="text" class="form-control" id="editPostTags" placeholder="Separate tags with commas">
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-sm btn-secondary px-3 py-2 small" data-bs-dismiss="modal" style="font-size: 0.75rem;">Cancel</button>
                        <button type="button" class="btn btn-sm btn-primary px-3 py-2 small" onclick="updatePost()" style="font-size: 0.75rem;">Update Post</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- View Post Modal -->
        <div class="modal fade" id="viewPostModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Blog Post Preview</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <img src="assets/images/blog/blog-01.jpg" class="img-fluid mb-3" alt="">
                        <h3>10 Tips for Learning Tajweed</h3>
                        <p class="text-muted">Published on: 2024-01-15 | Views: 1,245</p>
                        <p>Learn the essential rules of Tajweed to improve your Quranic recitation. Master proper pronunciation, articulation points, and rhythm to recite the Quran beautifully and correctly...</p>
                    </div>
                </div>
            </div>
        </div>

        <a href="#" class="back-to-top">
            <i class="icofont-simple-up"></i>
        </a>

    </div>

    <!-- jQuery from CDN with local fallback -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
    <script>
        // Fallback to local jQuery if CDN fails
        if (typeof jQuery === 'undefined') {
            document.write('<script src="assets/js/vendor/jquery-3.5.1.min.js"><\/script>');
        }
    </script>
    <!-- Bootstrap 5 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz" crossorigin="anonymous"></script>
    <script src="assets/js/vendor/modernizr-3.11.2.min.js"></script>
    <script src="assets/js/plugins.min.js"></script>
    <script src="assets/js/main.js"></script>
    <script>
        // Force production API URL for tayseerulquran.org
        if (window.location.hostname === 'tayseerulquran.org' || 
            window.location.hostname.includes('tayseerulquran.org')) {
            window.BACKEND_API_URL = 'https://tayseerulquran.onrender.com/api';
            console.log('Production API URL set to:', window.BACKEND_API_URL);
        }
    </script>
    <script src="assets/js/api.js"></script>
    <script src="assets/js/utils.js"></script>
    <script src="assets/js/role-access-control.js"></script>
    <script>
        // Debug: Check if required libraries are loaded
        console.log('jQuery loaded:', typeof jQuery !== 'undefined');
        console.log('API loaded:', typeof API !== 'undefined');
        console.log('Bootstrap loaded:', typeof bootstrap !== 'undefined');
        
        // Initialize Bootstrap if available
        if (typeof bootstrap === 'undefined' && typeof jQuery !== 'undefined') {
            // Try to initialize modals with jQuery if Bootstrap not available
            console.warn('Bootstrap not found, using jQuery for modals');
        }
        
        // Authentication and role check - MUST BE FIRST
        (function() {
            // Wait for API to load
            if (typeof API === 'undefined') {
                setTimeout(arguments.callee, 100);
                return;
            }
            
            const token = API.config.getAuthToken();
            const user = API.config.getUser();
            
            // Check authentication
            if (!token || !user) {
                console.log('No token or user found, redirecting to login');
                window.location.href = 'login.html';
                return;
            }
            
            // Check for super_admin role
            let hasSuperAdminRole = false;
            
            if (user.roles && Array.isArray(user.roles)) {
                hasSuperAdminRole = user.roles.some(role => {
                    const roleName = (role.name || role).toLowerCase();
                    return roleName === 'super_admin';
                });
            } else if (user.role) {
                hasSuperAdminRole = user.role.toLowerCase() === 'super_admin';
            }
            
            if (!hasSuperAdminRole) {
                console.log('Super admin access required. Current user roles:', user.roles);
                alert('Access denied. Super Admin access required.');
                
                // Redirect based on user's actual role
                if (user.roles && Array.isArray(user.roles)) {
                    const roleNames = user.roles.map(r => (r.name || r).toLowerCase());
                    if (roleNames.includes('admin')) {
                        window.location.href = 'admin-dashboard.html';
                    } else {
                        window.location.href = 'index.html';
                    }
                } else {
                    window.location.href = 'index.html';
                }
                return;
            }
            
            console.log('Super admin access granted');
        })();
        
        // Set role on page load (after verification)
        const user = API.config.getUser();
        if (user && user.roles) {
            const roleNames = user.roles.map(r => (r.name || r).toLowerCase());
            if (roleNames.includes('super_admin')) {
        localStorage.setItem('userRole', 'super_admin');
            }
        }
        
        let currentEditPostId = null;
        let blogCategories = [];
        
        // Show success/error message
        function showMessage(message, type = 'success') {
            const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
            const messageHtml = `<div class="alert ${alertClass} alert-dismissible fade show" role="alert" style="position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 300px;">
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>`;
            $('body').append(messageHtml);
            setTimeout(() => $('.alert').fadeOut(), 5000);
        }
        
        async function savePost() {
            console.log('savePost() called');
            try {
                if (typeof API === 'undefined') {
                    showMessage('API not loaded. Please refresh the page.', 'error');
                    console.error('API is not defined');
                    return;
                }
                
                // Get form values using IDs
                const title = $('#addPostTitle').val().trim();
                const category = $('#addPostCategory').val().trim();
                const content = $('#addPostContent').val().trim();
                const tags = $('#addPostTags').val().trim();
                const image = $('#addPostImage').val().trim();
                
                if (!title) {
                    showMessage('Please enter a post title', 'error');
                    return;
                }
                
                if (!category) {
                    showMessage('Please enter a category', 'error');
                    return;
                }
                
                if (!content) {
                    showMessage('Please enter post content', 'error');
                    return;
                }
                
                const postData = {
                    title: title,
                    content: content,
                    category: category,
                    tags: tags || '',
                    isPublished: true
                };
                
                // Add image if provided
                if (image) {
                    postData.featuredImage = image;
                }
                
                console.log('Creating blog post:', postData);
                const response = await API.blog.create(postData);
                
                if (response.success) {
                    showMessage('Blog post published successfully!');
            $('#createPostModal').modal('hide');
                    // Reset form
                    $('#createPostForm')[0].reset();
                    $('#addPostImagePreview').hide().attr('src', '');
                    $('#addPostImagePlaceholder').show();
                    // Reload the table and categories
                    await loadBlogPosts();
                    await loadBlogCategories();
                } else {
                    showMessage(response.message || 'Failed to create blog post', 'error');
                }
            } catch (error) {
                console.error('Error creating post:', error);
                // Show detailed error message
                let errorMessage = 'Failed to create blog post. Please try again.';
                if (error.response && error.response.data) {
                    const errorData = error.response.data;
                    if (errorData.message) {
                        errorMessage = errorData.message;
                    } else if (errorData.error) {
                        errorMessage = errorData.error;
                    } else if (errorData.details && Array.isArray(errorData.details)) {
                        errorMessage = errorData.details.map(d => d.message).join(', ');
                    }
                } else if (error.message) {
                    errorMessage = error.message;
                }
                showMessage(errorMessage, 'error');
            }
        }
        
        async function updatePost() {
            if (!currentEditPostId) {
                showMessage('Post ID not found', 'error');
                return;
            }
            
            try {
                // Get form values using IDs
                const title = $('#editPostTitle').val().trim();
                const category = $('#editPostCategory').val().trim();
                const content = $('#editPostContent').val().trim();
                const tags = $('#editPostTags').val().trim();
                const image = $('#editPostImage').val().trim();
                
                if (!title) {
                    showMessage('Please enter a post title', 'error');
                    return;
                }
                
                if (!category) {
                    showMessage('Please enter a category', 'error');
                    return;
                }
                
                if (!content) {
                    showMessage('Please enter post content', 'error');
                    return;
                }
                
                const postData = {
                    title: title,
                    content: content,
                    category: category,
                    tags: tags || '',
                    isPublished: true
                };
                
                // Add image if provided
                if (image) {
                    postData.featuredImage = image;
                }
                
                console.log('Updating blog post:', postData);
                const response = await API.blog.update(currentEditPostId, postData);
                
                if (response.success) {
                    showMessage('Blog post updated successfully!');
            $('#editPostModal').modal('hide');
                    currentEditPostId = null;
                    // Reload the table and categories
                    await loadBlogPosts();
                    await loadBlogCategories();
                } else {
                    showMessage(response.message || 'Failed to update blog post', 'error');
                }
            } catch (error) {
                console.error('Error updating post:', error);
                showMessage(error.message || 'Failed to update blog post. Please try again.', 'error');
            }
        }
        
        async function deletePost(id) {
            console.log('deletePost() called with id:', id, 'type:', typeof id);
            if (!confirm('Are you sure you want to delete this blog post? This action cannot be undone.')) {
                return;
            }
            
            try {
                if (typeof API === 'undefined') {
                    showMessage('API not loaded. Please refresh the page.', 'error');
                    console.error('API is not defined');
                    return;
                }
                
                // Ensure ID is a number
                const postId = parseInt(id);
                if (isNaN(postId)) {
                    showMessage('Invalid blog post ID', 'error');
                    console.error('Invalid ID:', id);
                    return;
                }
                
                // First, verify the post exists by trying to get it
                console.log('Verifying post exists before delete...');
                try {
                    const verifyResponse = await API.blog.getById(postId);
                    if (!verifyResponse.success) {
                        showMessage('Blog post not found. It may have already been deleted.', 'error');
                        // Reload the list to refresh
                        loadBlogPosts();
                        return;
                    }
                    console.log('Post verified:', verifyResponse.data);
                } catch (verifyError) {
                    console.error('Error verifying post:', verifyError);
                    showMessage('Blog post not found. It may have already been deleted.', 'error');
                    loadBlogPosts(); // Reload to refresh
                    return;
                }
                
                console.log('Calling API.blog.delete with ID:', postId);
                const response = await API.blog.delete(postId);
                console.log('Delete response:', response);
                
                if (response.success) {
                    showMessage('Blog post deleted successfully!');
                    // Remove row from table immediately
                    $(`tr[data-post-id="${postId}"]`).fadeOut(300, function() {
                        $(this).remove();
                        // Reload if table is empty
                        if ($('#blogPostsTableBody tr').length === 0) {
                            loadBlogPosts();
                        }
                    });
                    // Reload the list to refresh
                    setTimeout(() => loadBlogPosts(), 500);
                } else {
                    const errorMsg = response.message || 'Failed to delete blog post';
                    if (errorMsg.includes('foreign key') || errorMsg.includes('constraint') || errorMsg.includes('Cannot delete')) {
                        showMessage('Cannot delete this blog post because it has related records. Please remove related records first or contact an administrator.', 'error');
                    } else {
                        showMessage(errorMsg, 'error');
                    }
                }
            } catch (error) {
                console.error('Error deleting post:', error);
                console.error('Error details:', {
                    message: error.message,
                    stack: error.stack,
                    name: error.name
                });
                let errorMessage = error.message || 'Failed to delete blog post. Please try again.';
                if (errorMessage.includes('foreign key') || errorMessage.includes('constraint') || errorMessage.includes('Cannot delete')) {
                    showMessage('Cannot delete this blog post because it has related records. Please remove related records first or contact an administrator.', 'error');
                } else {
                    showMessage(errorMessage, 'error');
                }
                // Reload the list in case of error
                loadBlogPosts();
            }
        }
        
        // Load blog posts from API
        async function loadBlogPosts() {
            try {
                if (typeof API === 'undefined') {
                    console.error('API not loaded');
                    $('#blogPostsTableBody').html('<tr><td colspan="7" class="text-center text-danger">API not loaded. Please refresh the page.</td></tr>');
                    return;
                }
                
                console.log('Loading blog posts from API...');
                const response = await API.blog.getAll();
                console.log('Blog API response:', response);
                
                const tbody = $('#blogPostsTableBody');
                
                // Handle different response formats
                let posts = [];
                if (response.success && response.data) {
                    // Check if posts is in response.data.posts or response.data directly
                    posts = response.data.posts || response.data || [];
                } else if (Array.isArray(response)) {
                    // If response is directly an array
                    posts = response;
                } else if (response.posts) {
                    // If posts is at root level
                    posts = response.posts;
                }
                
                console.log('Posts found:', posts.length);
                posts.forEach((post, index) => {
                    console.log(`Post ${index + 1}: ID=${post.id}, Title=${post.title || 'Untitled'}`);
                });
                
                if (Array.isArray(posts) && posts.length > 0) {
                    
                    if (posts.length === 0) {
                        tbody.html('<tr><td colspan="7" class="text-center text-muted">No blog posts found. Create your first post!</td></tr>');
                        return;
                    }
                    
                    let html = '';
                    posts.forEach(post => {
                        const author = post.author ? `${post.author.firstName} ${post.author.lastName}` : 'Unknown';
                        const publishedDate = post.publishedAt ? new Date(post.publishedAt).toLocaleDateString() : 'Draft';
                        const status = post.isPublished ? '<span class="badge bg-success">Published</span>' : '<span class="badge bg-warning">Draft</span>';
                        
                        html += `
                            <tr data-post-id="${post.id}">
                                <td>
                                    <div class="d-flex align-items-center">
                                        <img src="${post.featuredImage || 'assets/images/blog/blog-01.jpg'}" class="me-3" width="60" height="60" style="object-fit: cover; border-radius: 5px;" alt="">
                                        <div>
                                            <strong>${post.title || 'Untitled'}</strong>
                                            <br><small class="text-muted">${(post.excerpt || post.content || '').substring(0, 50)}...</small>
                                        </div>
                                    </div>
                                </td>
                                <td>${author}</td>
                                <td>${post.category || 'General'}</td>
                                <td>${publishedDate}</td>
                                <td>${post.views || 0}</td>
                                <td>${status}</td>
                                <td>
                                    <button class="btn btn-sm btn-info px-2 py-1" onclick="viewPost(${post.id})" data-post-id="${post.id}" style="font-size: 0.7rem;">
                                        <i class="icofont-eye"></i>
                                    </button>
                                    <button class="btn btn-sm btn-warning px-2 py-1" onclick="openEditPostModal(${post.id})" data-post-id="${post.id}" data-permission="edit_blog_post" style="font-size: 0.7rem;">
                                        <i class="icofont-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-danger px-2 py-1" onclick="deletePost(${post.id})" data-post-id="${post.id}" data-permission="delete_blog_post" style="font-size: 0.7rem;">
                                        <i class="icofont-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        `;
                    });
                    
                    tbody.html(html);
                } else if (Array.isArray(posts) && posts.length === 0) {
                    tbody.html('<tr><td colspan="7" class="text-center text-muted">No blog posts found. Create your first post!</td></tr>');
                } else {
                    console.error('Unexpected response format:', response);
                    tbody.html('<tr><td colspan="7" class="text-center text-warning">No posts found or unexpected response format. Check console for details.</td></tr>');
                }
            } catch (error) {
                console.error('Error loading blog posts:', error);
                console.error('Error details:', {
                    message: error.message,
                    stack: error.stack,
                    name: error.name
                });
                $('#blogPostsTableBody').html(`<tr><td colspan="7" class="text-center text-danger">Error loading blog posts: ${error.message || 'Unknown error'}. Please check console and refresh the page.</td></tr>`);
            }
        }
        
        // Open edit post modal
        async function openEditPostModal(postId) {
            currentEditPostId = postId;
            
            // Load post data into form
            await loadPostData(postId);
            $('#editPostModal').modal('show');
        }
        
        // View post details
        async function viewPost(postId) {
            try {
                if (typeof API === 'undefined') {
                    showMessage('API not loaded. Please refresh the page.', 'error');
                    return;
                }
                
                const response = await API.blog.getById(postId);
                if (response.success && response.data && response.data.post) {
                    const post = response.data.post;
                    const author = post.author ? `${post.author.firstName} ${post.author.lastName}` : 'Unknown';
                    const publishedDate = post.publishedAt ? new Date(post.publishedAt).toLocaleDateString() : 'Draft';
                    const views = post.views || 0;
                    
                    // Update modal content
                    $('#viewPostModal .modal-body').html(`
                        <img src="${post.featuredImage || 'assets/images/blog/blog-01.jpg'}" class="img-fluid mb-3" alt="">
                        <h3>${post.title || 'Untitled'}</h3>
                        <p class="text-muted">Published on: ${publishedDate} | Views: ${views} | Author: ${author}</p>
                        <p>${post.content || 'No content available'}</p>
                        ${post.tags ? `<p class="text-muted"><strong>Tags:</strong> ${post.tags}</p>` : ''}
                    `);
                    
                    $('#viewPostModal').modal('show');
                } else {
                    showMessage('Failed to load post details', 'error');
                }
            } catch (error) {
                console.error('Error loading post:', error);
                showMessage('Failed to load post details. Please try again.', 'error');
            }
        }
        
        // Keep backward compatibility
        $(document).on('click', '[data-bs-target="#editPostModal"]', function() {
            const postId = $(this).data('post-id');
            if (postId) {
                openEditPostModal(postId);
            }
        });
        
        // Load post data for editing
        async function loadPostData(postId) {
            try {
                const response = await API.blog.getById(postId);
                if (response.success && response.data && response.data.post) {
                    const post = response.data.post;
                    // Use IDs to populate form fields
                    $('#editPostTitle').val(post.title || '');
                    $('#editPostCategory').val(post.category || '');
                    $('#editPostContent').val(post.content || '');
                    $('#editPostTags').val(post.tags || '');
                    $('#editPostImage').val(post.featuredImage || '');
                    
                    // Update image preview
                    if (post.featuredImage) {
                        $('#editPostImagePreview').attr('src', post.featuredImage).show();
                        $('#editPostImagePlaceholder').hide();
                    } else {
                        $('#editPostImagePreview').hide().attr('src', '');
                        $('#editPostImagePlaceholder').show();
                    }
                }
            } catch (error) {
                console.error('Error loading post data:', error);
                showMessage('Failed to load post data', 'error');
            }
        }
        
        // Load categories from existing blog posts
        async function loadBlogCategories() {
            try {
                if (typeof API === 'undefined' || typeof API.blog === 'undefined') {
                    return;
                }
                
                const response = await API.blog.getAll();
                let posts = [];
                if (response.success && response.data) {
                    posts = response.data.posts || response.data || [];
                } else if (Array.isArray(response)) {
                    posts = response;
                }
                
                // Extract unique categories
                const categoriesSet = new Set();
                posts.forEach(post => {
                    if (post.category && post.category.trim()) {
                        categoriesSet.add(post.category.trim());
                    }
                });
                
                // Add default categories if none exist
                if (categoriesSet.size === 0) {
                    ['Qur\'an Reading', 'Tajweed', 'Hifdh (Memorisation)', 'Arabic Language', 'Islamic Studies', 'Children', 'Sisters', 'General', 'News', 'Tips & Advice'].forEach(cat => {
                        categoriesSet.add(cat);
                    });
                }
                
                blogCategories = Array.from(categoriesSet).sort();
                updateCategoryDatalists();
            } catch (error) {
                console.error('Error loading blog categories:', error);
                // Use default categories on error
                blogCategories = ['Qur\'an Reading', 'Tajweed', 'Hifdh (Memorisation)', 'Arabic Language', 'Islamic Studies', 'Children', 'Sisters', 'General', 'News', 'Tips & Advice'];
                updateCategoryDatalists();
            }
        }
        
        // Update category datalists (autocomplete suggestions)
        function updateCategoryDatalists() {
            const categoryList = $('#blogCategoryList');
            const categoryListEdit = $('#blogCategoryListEdit');
            
            // Clear existing options
            categoryList.empty();
            categoryListEdit.empty();
            
            // Add categories as options
            blogCategories.forEach(category => {
                categoryList.append(`<option value="${category}">`);
                categoryListEdit.append(`<option value="${category}">`);
            });
        }
        
        // Image URL preview handler
        function setupImageUrlPreview(inputId, previewId, placeholderId) {
            $(`#${inputId}`).on('input', function() {
                const url = $(this).val().trim();
                if (url) {
                    const img = new Image();
                    img.onload = function() {
                        $(`#${previewId}`).attr('src', url).show();
                        $(`#${placeholderId}`).hide();
                    };
                    img.onerror = function() {
                        $(`#${previewId}`).hide().attr('src', '');
                        $(`#${placeholderId}`).show().html('<i class="icofont-warning" style="font-size: 1rem; color: #dc3545;"></i><br>Invalid');
                    };
                    img.src = url;
                } else {
                    $(`#${previewId}`).hide().attr('src', '');
                    $(`#${placeholderId}`).show().html('<i class="icofont-image" style="font-size: 1.5rem; display: block;"></i>Preview');
                }
            });
        }
        
        // Set active menu item based on current page
        function setActiveMenuItem() {
            const currentPage = window.location.pathname.split('/').pop() || window.location.href.split('/').pop();
            $('.admin-tab-menu a').removeClass('active');
            $('.admin-tab-menu a').each(function() {
                const href = $(this).attr('href');
                if (href === currentPage || (currentPage === '' && href === 'super-admin-dashboard.html')) {
                    $(this).addClass('active');
                }
            });
        }

        // Logout function
        function handleLogout() {
            if (confirm('Are you sure you want to logout?')) {
                try {
                    if (typeof API !== 'undefined' && API.auth && API.auth.logout) {
                        API.auth.logout();
                    } else {
                        // Fallback if API not loaded
                        localStorage.removeItem('authToken');
                        localStorage.removeItem('user');
                        window.location.href = 'login.html';
                    }
                } catch (error) {
                    console.error('Error during logout:', error);
                    // Fallback logout
                    localStorage.removeItem('authToken');
                    localStorage.removeItem('user');
                    window.location.href = 'login.html';
                }
            }
        }
        
        // Load posts and categories on page load
        $(document).ready(function() {
            // Set active menu item
            setActiveMenuItem();
            
            loadBlogPosts();
            loadBlogCategories();
            
            // Setup image URL previews
            setupImageUrlPreview('addPostImage', 'addPostImagePreview', 'addPostImagePlaceholder');
            setupImageUrlPreview('editPostImage', 'editPostImagePreview', 'editPostImagePlaceholder');
        });
    </script>

</body>

</html>

