<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <title>Manage Courses - Super Admin</title>
    <meta name="robots" content="noindex, follow" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="shortcut icon" type="image/x-icon" href="assets/images/favicon.ico">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800;900&display=swap"
        rel="stylesheet">

    <link rel="stylesheet" href="assets/css/plugins/icofont.min.css">
    <link rel="stylesheet" href="assets/css/plugins/flaticon.css">
    <link rel="stylesheet" href="assets/css/plugins/font-awesome.min.css">
    <link rel="stylesheet" href="assets/css/plugins/animate.min.css">
    <link rel="stylesheet" href="assets/css/plugins/swiper-bundle.min.css">
    <link rel="stylesheet" href="assets/css/plugins/magnific-popup.css">
    <link rel="stylesheet" href="assets/css/plugins/nice-select.css">
    <link rel="stylesheet" href="assets/css/style.css">
    <style>
        /* Admin Tab Menu as Main Sidebar */
        .admin-tab-menu {
            position: fixed;
            left: 0;
            top: 80px;
            bottom: 0;
            width: 350px;
            background: #fff;
            padding: 20px;
            z-index: 100;
            overflow-y: auto;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            border-right: 1px solid #e9ecef;
        }
        
        .admin-tab-menu a {
            display: block;
            padding: 12px 25px;
            color: #495057;
            text-decoration: none;
            border-left: 3px solid transparent;
            transition: all 0.3s ease;
            font-weight: 500;
            font-size: 14px;
        }
        
        .admin-tab-menu a:hover {
            background-color: #f8f9fa;
            color: #007bff;
            border-left-color: #007bff;
        }
        
        .admin-tab-menu a.active {
            background-color: #e7f3ff;
            color: #007bff;
            border-left-color: #007bff;
            font-weight: 600;
        }
        
        .page-content-wrapper {
            margin-left: 250px;
        }
        
        .main-content-wrapper {
            padding: 20px;
        }
        
        @media (max-width: 768px) {
            .admin-tab-menu {
                position: relative;
                left: 0;
                top: 0;
                width: 100%;
                margin-bottom: 20px;
                max-height: 300px;
            }
            
            .page-content-wrapper {
                margin-left: 0;
            }
        }
    </style>
</head>

<body>

    <div class="main-wrapper main-wrapper-02">

        <!-- Login Header Start -->
        <div class="section login-header">
            <div class="login-header-wrapper navbar navbar-expand">
                <div class="login-header-logo">
                    <a href="super-admin-dashboard.html"><img src="assets/images/logo-icon.png" alt="Logo"></a>
                </div>
                <div class="login-header-action ml-auto d-flex align-items-center gap-3">
                    <button class="btn btn-sm btn-outline-danger px-3 py-2" onclick="handleLogout()" style="font-size: 0.75rem;">
                        <i class="icofont-logout me-1"></i> Logout
                    </button>
                    <a class="action author" href="#">
                        <img src="assets/images/author/author-07.jpg" alt="Author">
                    </a>
                    <div class="dropdown">
                        <button class="action more" data-bs-toggle="dropdown">
                            <span></span>
                            <span></span>
                            <span></span>
                        </button>
                        <ul class="dropdown-menu">
                            <li><a href="super-admin-dashboard.html"><i class="icofont-home"></i> Dashboard</a></li>
                            <li><a href="#" onclick="handleLogout(); return false;"><i class="icofont-logout"></i> Sign Out</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Courses Admin Start -->
        <div class="section overflow-hidden position-relative" id="wrapper">
            <div class="page-content-wrapper py-0">
                <!-- Admin Tab Menu Start - Main Sidebar -->
                <div class="nav flex-column nav-pills admin-tab-menu">
                    <a href="super-admin-dashboard.html">Dashboard</a>
                    <a href="super-admin-courses.html" data-permission="view_courses">Courses</a>
                    <a href="super-admin-students.html" data-permission="view_students">Students</a>
                    <a href="super-admin-tutors.html" data-permission="view_tutors">Tutors</a>
                    <a href="super-admin-payments.html" data-permission="view_payments">Payments</a>
                    <a href="super-admin-roles.html" data-role="super_admin">Admin Roles</a>
                    <a href="super-admin-blog.html" data-permission="view_blog_posts">Blog</a>
                </div>
                <!-- Admin Tab Menu End -->

                <div class="main-content-wrapper">
                    <div class="container-fluid">
                        <div class="admin-top-bar flex-wrap mb-4">
                            <div>
                                <h3 class="title mb-2">Course Management</h3>
                                <p class="text-muted">Add, edit, or delete courses</p>
                            </div>
                            <button class="btn btn-sm btn-primary px-3 py-2 small" data-bs-toggle="modal"
                                data-bs-target="#addCourseModal" data-permission="add_course"
                                style="font-size: 0.75rem;">
                                <i class="icofont-plus me-1"></i> Add New Course
                            </button>
                        </div>

                        <!-- Courses Table -->
                        <div class="card border-0 shadow-sm">
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover" id="coursesTable">
                                        <thead>
                                            <tr>
                                                <th>ID</th>
                                                <th>Course Title</th>
                                                <th>Instructor</th>
                                                <th>Category</th>
                                                <th>Price</th>
                                                <th>Students</th>
                                                <th>Status</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td colspan="8" class="text-center">
                                                    <div class="spinner-border text-primary" role="status">
                                                        <span class="visually-hidden">Loading...</span>
                                                    </div>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Add Course Modal -->
        <div class="modal fade" id="addCourseModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Add New Course</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="addCourseForm">
                            <div class="mb-3">
                                <label class="form-label">Course Title</label>
                                <input type="text" class="form-control" id="addCourseTitle" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Description</label>
                                <textarea class="form-control" id="addCourseDescription" rows="4" required></textarea>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Category</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="addCourseCategory"
                                            list="categoryList" placeholder="Type category name" required>
                                        <datalist id="categoryList">
                                            <!-- Options will be populated dynamically -->
                                        </datalist>
                                        <button type="button" class="btn btn-outline-secondary"
                                            onclick="openCategoryManager()" title="Manage Categories">
                                            <i class="icofont-settings"></i>
                                        </button>
                                    </div>
                                    <small class="text-muted">Type category name or select from suggestions</small>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Price ($)</label>
                                    <input type="number" class="form-control" id="addCoursePrice" step="0.01" required>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Assign Instructor</label>
                                <input type="text" class="form-control" id="addCourseInstructorName"
                                    list="instructorList" placeholder="Type instructor name (optional)"
                                    autocomplete="off">
                                <datalist id="instructorList">
                                    <!-- Options will be populated dynamically -->
                                </datalist>
                                <small class="text-muted">Type instructor name or select from suggestions
                                    (optional)</small>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Course Image URL</label>
                                <div class="row align-items-center">
                                    <div class="col-md-8">
                                        <input type="url" class="form-control" id="addCourseImage"
                                            placeholder="https://example.com/image.jpg">
                                        <small class="text-muted">
                                            Paste an image URL. Get free images from:
                                            <a href="https://unsplash.com" target="_blank">Unsplash</a>,
                                            <a href="https://pexels.com" target="_blank">Pexels</a>, or
                                            <a href="https://imgbb.com" target="_blank">ImgBB</a> (upload your own)
                                        </small>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="image-preview-container"
                                            style="width: 100%; height: 120px; border: 2px dashed #ddd; border-radius: 8px; display: flex; align-items: center; justify-content: center; overflow: hidden; background: #f8f9fa;">
                                            <img id="addCourseImagePreview" src="" alt="Preview"
                                                style="max-width: 100%; max-height: 100%; display: none; object-fit: cover;">
                                            <span id="addCourseImagePlaceholder" class="text-muted text-center"
                                                style="font-size: 0.75rem;"><i class="icofont-image"
                                                    style="font-size: 2rem; display: block;"></i>Image Preview</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Duration (hours)</label>
                                    <input type="number" class="form-control" id="addCourseDuration" min="1"
                                        placeholder="e.g., 10">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Level</label>
                                    <select class="form-control" id="addCourseLevel">
                                        <option value="">Select Level</option>
                                        <option value="beginner">Beginner</option>
                                        <option value="intermediate">Intermediate</option>
                                        <option value="advanced">Advanced</option>
                                    </select>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-sm btn-secondary px-3 py-2 small" data-bs-dismiss="modal"
                            style="font-size: 0.75rem;">Cancel</button>
                        <button type="button" class="btn btn-sm btn-primary px-3 py-2 small" onclick="saveCourse()"
                            style="font-size: 0.75rem;">Save Course</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Edit Course Modal -->
        <div class="modal fade" id="editCourseModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Edit Course</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="editCourseForm">
                            <div class="mb-3">
                                <label class="form-label">Course Title</label>
                                <input type="text" class="form-control" id="editCourseTitle" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Description</label>
                                <textarea class="form-control" id="editCourseDescription" rows="4" required></textarea>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Category</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="editCourseCategory"
                                            list="categoryListEdit" placeholder="Type category name" required>
                                        <datalist id="categoryListEdit">
                                            <!-- Options will be populated dynamically -->
                                        </datalist>
                                        <button type="button" class="btn btn-outline-secondary"
                                            onclick="openCategoryManager()" title="Manage Categories">
                                            <i class="icofont-settings"></i>
                                        </button>
                                    </div>
                                    <small class="text-muted">Type category name or select from suggestions</small>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Price ($)</label>
                                    <input type="number" class="form-control" id="editCoursePrice" step="0.01" required>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Course Image URL</label>
                                <div class="row align-items-center">
                                    <div class="col-md-8">
                                        <input type="url" class="form-control" id="editCourseImage"
                                            placeholder="https://example.com/image.jpg">
                                        <small class="text-muted">
                                            Paste an image URL. Get free images from:
                                            <a href="https://unsplash.com" target="_blank">Unsplash</a>,
                                            <a href="https://pexels.com" target="_blank">Pexels</a>, or
                                            <a href="https://imgbb.com" target="_blank">ImgBB</a> (upload your own)
                                        </small>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="image-preview-container"
                                            style="width: 100%; height: 120px; border: 2px dashed #ddd; border-radius: 8px; display: flex; align-items: center; justify-content: center; overflow: hidden; background: #f8f9fa;">
                                            <img id="editCourseImagePreview" src="" alt="Preview"
                                                style="max-width: 100%; max-height: 100%; display: none; object-fit: cover;">
                                            <span id="editCourseImagePlaceholder" class="text-muted text-center"
                                                style="font-size: 0.75rem;"><i class="icofont-image"
                                                    style="font-size: 2rem; display: block;"></i>Image Preview</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Duration (hours)</label>
                                    <input type="number" class="form-control" id="editCourseDuration" min="1"
                                        placeholder="e.g., 10">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Level</label>
                                    <select class="form-control" id="editCourseLevel">
                                        <option value="">Select Level</option>
                                        <option value="beginner">Beginner</option>
                                        <option value="intermediate">Intermediate</option>
                                        <option value="advanced">Advanced</option>
                                    </select>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-sm btn-secondary px-3 py-2 small" data-bs-dismiss="modal"
                            style="font-size: 0.75rem;">Cancel</button>
                        <button type="button" class="btn btn-sm btn-primary px-3 py-2 small" onclick="updateCourse()"
                            style="font-size: 0.75rem;">Update Course</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Category Management Modal -->
        <div class="modal fade" id="categoryManagerModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Manage Course Categories</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">Add New Category</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="newCategoryName"
                                    placeholder="Enter category name">
                                <button type="button" class="btn btn-primary" onclick="addCategoryToList()">
                                    <i class="icofont-plus"></i> Add
                                </button>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Existing Categories</label>
                            <div id="categoriesList" class="list-group" style="max-height: 300px; overflow-y: auto;">
                                <div class="text-center text-muted p-3">Loading categories...</div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-sm btn-secondary px-3 py-2 small" data-bs-dismiss="modal"
                            style="font-size: 0.75rem;">Close</button>
                    </div>
                </div>
            </div>
        </div>

        <a href="#" class="back-to-top">
            <i class="icofont-simple-up"></i>
        </a>

    </div>

    <!-- jQuery from CDN -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"
        integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
    <script>
        if (typeof jQuery === 'undefined') {
            const script = document.createElement('script');
            script.src = 'assets/js/vendor/jquery-3.5.1.min.js';
            document.head.appendChild(script);
        }
    </script>
    <!-- Bootstrap 5 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz"
        crossorigin="anonymous"></script>
    <script src="assets/js/vendor/modernizr-3.11.2.min.js"></script>
    <script>
        const pluginsScript = document.createElement('script');
        pluginsScript.src = 'assets/js/plugins.min.js';
        pluginsScript.onerror = function () {
            console.warn('plugins.min.js not found, continuing without it');
        };
        document.head.appendChild(pluginsScript);
    </script>
    <script src="assets/js/main.js"></script>
    <script src="assets/js/api.js"></script>
    <script src="assets/js/utils.js"></script>
    <script src="assets/js/role-access-control.js"></script>
    <script>
        // Authentication and role check - MUST BE FIRST
        (function () {
            // Wait for API to load
            if (typeof API === 'undefined') {
                setTimeout(arguments.callee, 100);
                return;
            }

            const token = API.config.getAuthToken();
            const user = API.config.getUser();

            // Check authentication
            if (!token || !user) {
                console.log('No token or user found, redirecting to login');
                window.location.href = 'login.html';
                return;
            }

            // Check for super_admin role
            let hasSuperAdminRole = false;

            if (user.roles && Array.isArray(user.roles)) {
                hasSuperAdminRole = user.roles.some(role => {
                    const roleName = (role.name || role).toLowerCase();
                    return roleName === 'super_admin';
                });
            } else if (user.role) {
                hasSuperAdminRole = user.role.toLowerCase() === 'super_admin';
            }

            if (!hasSuperAdminRole) {
                console.log('Super admin access required. Current user roles:', user.roles);
                alert('Access denied. Super Admin access required.');

                // Redirect based on user's actual role
                if (user.roles && Array.isArray(user.roles)) {
                    const roleNames = user.roles.map(r => (r.name || r).toLowerCase());
                    if (roleNames.includes('admin')) {
                        window.location.href = 'admin-dashboard.html';
                    } else {
                        window.location.href = 'index.html';
                    }
                } else {
                    window.location.href = 'index.html';
                }
                return;
            }

            console.log('Super admin access granted');
        })();

        // Set role on page load (after verification)
        const user = API.config.getUser();
        if (user && user.roles) {
            const roleNames = user.roles.map(r => (r.name || r).toLowerCase());
            if (roleNames.includes('super_admin')) {
                localStorage.setItem('userRole', 'super_admin');
            }
        }

        let currentEditCourseId = null;

        function showMessage(message, type = 'success') {
            let alertClass = 'alert-success';
            if (type === 'error') {
                alertClass = 'alert-danger';
            } else if (type === 'warning') {
                alertClass = 'alert-warning';
            }
            const messageHtml = `<div class="alert ${alertClass} alert-dismissible fade show" role="alert" style="position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 300px;">
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>`;
            $('body').append(messageHtml);
            setTimeout(() => $('.alert').fadeOut(), 5000);
        }

        // Load courses from API
        async function loadCourses() {
            try {
                if (typeof API === 'undefined' || typeof API.course === 'undefined') {
                    console.error('API not loaded');
                    return;
                }

                console.log('Loading courses from API...');
                const response = await API.course.getAll();
                const tbody = $('#coursesTable tbody');

                if (response.success && response.data) {
                    const courses = response.data.courses || response.data || [];

                    if (courses.length === 0) {
                        tbody.html('<tr><td colspan="8" class="text-center text-muted">No courses found. Create your first course!</td></tr>');
                        return;
                    }

                    // Load enrollments to get student counts per course
                    let enrollmentMap = {};
                    try {
                        if (API.enrollment) {
                            const enrollmentsResponse = await API.enrollment.getAll({ limit: 10000 });
                            if (enrollmentsResponse.success && enrollmentsResponse.data) {
                                const enrollments = enrollmentsResponse.data.enrollments || [];
                                enrollments.forEach(enrollment => {
                                    const courseId = enrollment.courseId || enrollment.Course?.id;
                                    if (courseId) {
                                        enrollmentMap[courseId] = (enrollmentMap[courseId] || 0) + 1;
                                    }
                                });
                            }
                        }
                    } catch (e) {
                        console.warn('Error loading enrollments:', e);
                    }

                    let html = '';
                    courses.forEach(course => {
                        const instructor = course.tutor?.user ? `${course.tutor.user.firstName} ${course.tutor.user.lastName}` : 'Unassigned';
                        const price = course.price ? '$' + parseFloat(course.price).toFixed(2) : 'Free';
                        const status = course.isPublished ? '<span class="badge bg-success">Published</span>' : '<span class="badge bg-warning">Draft</span>';
                        // Use enrollment count from enrollmentMap, fallback to course.enrollmentCount or 0
                        const students = enrollmentMap[course.id] || course.enrollmentCount || 0;

                        html += `
                            <tr data-course-id="${course.id}">
                                <td>${course.id}</td>
                                <td>${course.title || 'Untitled'}</td>
                                <td>${instructor}</td>
                                <td>${course.category || 'General'}</td>
                                <td>${price}</td>
                                <td>${students}</td>
                                <td>${status}</td>
                                <td>
                                    <button class="btn btn-sm btn-info px-2 py-1" onclick="openEditCourseModal(${course.id})" data-course-id="${course.id}" style="font-size: 0.7rem;">
                                        <i class="icofont-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-danger px-2 py-1" onclick="deleteCourse(${course.id})" style="font-size: 0.7rem;">
                                        <i class="icofont-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        `;
                    });

                    tbody.html(html);
                } else {
                    tbody.html('<tr><td colspan="8" class="text-center text-muted">Failed to load courses</td></tr>');
                }
            } catch (error) {
                console.error('Error loading courses:', error);
                $('#coursesTable tbody').html(`<tr><td colspan="8" class="text-center text-danger">Error loading courses: ${error.message || 'Unknown error'}</td></tr>`);
            }
        }

        let allTutors = [];

        // Load tutors for instructor autocomplete
        async function loadTutors() {
            try {
                if (typeof API === 'undefined' || typeof API.tutor === 'undefined') {
                    return;
                }

                const response = await API.tutor.getAll();
                if (response.success && response.data) {
                    const tutors = response.data.tutors || response.data || [];
                    allTutors = tutors;

                    // Populate datalist with tutor names
                    const instructorDatalist = $('#instructorList');
                    let options = '';

                    tutors.forEach(tutor => {
                        if (tutor.user) {
                            const fullName = `${tutor.user.firstName} ${tutor.user.lastName}`.trim();
                            if (fullName) {
                                options += `<option value="${fullName}" data-tutor-id="${tutor.id}">${fullName}</option>`;
                            }
                        }
                    });

                    instructorDatalist.html(options);
                }
            } catch (error) {
                console.error('Error loading tutors:', error);
            }
        }

        let courseCategories = [];

        // Load categories from existing courses
        async function loadCategories() {
            try {
                if (typeof API === 'undefined' || typeof API.course === 'undefined') {
                    return;
                }

                const response = await API.course.getAll();
                if (response.success && response.data) {
                    const courses = response.data.courses || response.data || [];

                    // Extract unique categories
                    const categoriesSet = new Set();
                    courses.forEach(course => {
                        if (course.category && course.category.trim()) {
                            categoriesSet.add(course.category.trim());
                        }
                    });

                    // Add default categories if none exist
                    if (categoriesSet.size === 0) {
                        ['Web Development', 'Data Science', 'Design', 'Marketing', 'Business', 'Language', 'Photography', 'Music'].forEach(cat => {
                            categoriesSet.add(cat);
                        });
                    }

                    courseCategories = Array.from(categoriesSet).sort();
                    updateCategoryDropdowns();
                    updateCategoriesList();
                }
            } catch (error) {
                console.error('Error loading categories:', error);
                // Use default categories on error
                courseCategories = ['Web Development', 'Data Science', 'Design', 'Marketing', 'Business', 'Language', 'Photography', 'Music'];
                updateCategoryDropdowns();
                updateCategoriesList();
            }
        }

        // Update category datalists (autocomplete suggestions)
        function updateCategoryDropdowns() {
            const addDatalist = $('#categoryList');
            const editDatalist = $('#categoryListEdit');

            let options = '';
            courseCategories.forEach(category => {
                options += `<option value="${category}">${category}</option>`;
            });

            addDatalist.html(options);
            editDatalist.html(options);
        }

        // Update categories list in modal
        function updateCategoriesList() {
            const list = $('#categoriesList');
            list.empty();

            if (courseCategories.length === 0) {
                list.html('<div class="text-muted text-center p-3">No categories yet. Add your first category!</div>');
                return;
            }

            courseCategories.forEach((category, index) => {
                const item = $(`
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        <span>${category}</span>
                        <button type="button" class="btn btn-sm btn-danger" onclick="removeCategory(${index})" title="Remove Category">
                            <i class="icofont-trash"></i>
                        </button>
                    </div>
                `);
                list.append(item);
            });
        }

        // Open category manager modal
        function openCategoryManager() {
            updateCategoriesList();
            $('#categoryManagerModal').modal('show');
        }

        // Add category to list
        function addCategoryToList() {
            const input = $('#newCategoryName');
            const categoryName = input.val().trim();

            if (!categoryName) {
                showMessage('Please enter a category name', 'error');
                return;
            }

            if (courseCategories.includes(categoryName)) {
                showMessage('Category already exists', 'error');
                return;
            }

            courseCategories.push(categoryName);
            courseCategories.sort();
            updateCategoryDropdowns();
            updateCategoriesList();
            input.val('');
            showMessage('Category added successfully!');
        }

        // Remove category
        function removeCategory(index) {
            if (!confirm(`Are you sure you want to remove "${courseCategories[index]}"? This will not affect existing courses.`)) {
                return;
            }

            courseCategories.splice(index, 1);
            updateCategoryDropdowns();
            updateCategoriesList();
            showMessage('Category removed successfully!');
        }

        // Add new category from input field (kept for backward compatibility, but not needed with datalist)
        function addNewCategoryToForm(formType) {
            const input = formType === 'add' ? $('#addCourseCategory') : $('#editCourseCategory');
            const categoryName = input.val().trim();

            if (!categoryName) {
                showMessage('Please enter a category name', 'error');
                return;
            }

            // Add to categories list if not exists
            if (!courseCategories.includes(categoryName)) {
                courseCategories.push(categoryName);
                courseCategories.sort();
                updateCategoryDropdowns();
                updateCategoriesList();
                showMessage('Category added to list!');
            }
        }

        // Save new course
        async function saveCourse() {
            try {
                if (typeof API === 'undefined' || typeof API.course === 'undefined') {
                    showMessage('API not loaded. Please refresh the page.', 'error');
                    return;
                }

                const form = $('#addCourseForm');
                const title = $('#addCourseTitle').val().trim();
                const description = $('#addCourseDescription').val().trim();
                const category = $('#addCourseCategory').val().trim();
                const priceInput = $('#addCoursePrice').val().trim();
                const thumbnail = $('#addCourseImage').val().trim();
                const duration = $('#addCourseDuration').val();
                const level = $('#addCourseLevel').val();

                // Find tutor ID from instructor name (optional field)
                const instructorName = $('#addCourseInstructorName').val().trim();
                let tutorId = null;
                if (instructorName) {
                    // Only try to match if tutors are loaded
                    if (allTutors && allTutors.length > 0) {
                        const matchingTutor = allTutors.find(tutor => {
                            if (tutor.user) {
                                const fullName = `${tutor.user.firstName} ${tutor.user.lastName}`.trim();
                                return fullName.toLowerCase() === instructorName.toLowerCase();
                            }
                            return false;
                        });

                        if (matchingTutor) {
                            tutorId = matchingTutor.id;
                        } else {
                            // If name doesn't match, show warning but allow saving without instructor
                            console.warn('Instructor name not found:', instructorName);
                            showMessage('Instructor name not found. Course will be saved without instructor.', 'warning');
                            tutorId = null;
                        }
                    } else {
                        // If tutors haven't loaded yet, show warning but allow saving
                        console.warn('Tutors not loaded yet. Course will be saved without instructor.');
                        showMessage('Tutors not loaded. Course will be saved without instructor.', 'warning');
                        tutorId = null;
                    }
                }

                // Validate required fields
                if (!title || title.length < 3) {
                    showMessage('Course title is required and must be at least 3 characters', 'error');
                    return;
                }

                if (!description || description.trim().length === 0) {
                    showMessage('Description is required', 'error');
                    return;
                }

                if (!category || category.trim().length === 0) {
                    showMessage('Category is required', 'error');
                    return;
                }

                // Properly handle price - ensure it's a valid number >= 0
                let price = 0;
                if (priceInput && priceInput !== '') {
                    const parsedPrice = parseFloat(priceInput);
                    if (isNaN(parsedPrice) || parsedPrice < 0) {
                        showMessage('Please enter a valid price (0 or greater)', 'error');
                        return;
                    }
                    price = parsedPrice;
                }

                // If new category was entered, add it to the list
                if (!courseCategories.includes(category)) {
                    courseCategories.push(category);
                    courseCategories.sort();
                    updateCategoryDropdowns();
                    updateCategoriesList();
                }

                const courseData = {
                    title: title,
                    description: description || '',
                    category: category || '',
                    price: price
                };

                // Only add tutorId if it's valid
                if (tutorId) {
                    courseData.tutorId = parseInt(tutorId);
                }

                // Add thumbnail if provided
                if (thumbnail) {
                    courseData.thumbnail = thumbnail;
                }

                // Add duration if provided
                if (duration) {
                    courseData.duration = parseInt(duration);
                }

                // Add level if provided
                if (level) {
                    courseData.level = level;
                }

                // Add publishing flags
                courseData.isPublished = true;
                courseData.isActive = true;

                console.log('Creating course:', courseData);
                const response = await API.course.create(courseData);

                if (response.success) {
                    showMessage('Course created successfully!');
                    $('#addCourseModal').modal('hide');
                    // Reset form
                    form[0].reset();
                    $('#addCourseTitle').val('');
                    $('#addCourseDescription').val('');
                    $('#addCourseCategory').val('');
                    $('#addCoursePrice').val('');
                    $('#addCourseInstructorName').val('');
                    $('#addCourseImage').val('');
                    $('#addCourseDuration').val('');
                    $('#addCourseLevel').val('');
                    // Reset image preview
                    $('#addCourseImagePreview').hide().attr('src', '');
                    $('#addCourseImagePlaceholder').show().html('<i class="icofont-image" style="font-size: 2rem; display: block;"></i>Image Preview');
                    loadCourses();
                    loadCategories(); // Reload categories to include new one
                } else {
                    // Show detailed error message
                    const errorMsg = response.message || response.error || 'Failed to create course';
                    showMessage(errorMsg, 'error');
                }
            } catch (error) {
                console.error('Error creating course:', error);
                // Check if error has validation details from backend
                let errorMessage = 'Failed to create course. Please try again.';

                if (error.response && error.response.data) {
                    const errorData = error.response.data;
                    if (errorData.message) {
                        errorMessage = errorData.message;
                    } else if (errorData.error) {
                        errorMessage = errorData.error;
                    } else if (errorData.details && Array.isArray(errorData.details)) {
                        // Joi validation errors
                        errorMessage = errorData.details.map(d => d.message).join(', ');
                    }
                } else if (error.message) {
                    errorMessage = error.message;
                }

                showMessage(errorMessage, 'error');
            }
        }

        // Update course
        async function updateCourse() {
            if (!currentEditCourseId) {
                showMessage('Course ID not found for update', 'error');
                return;
            }

            try {
                if (typeof API === 'undefined' || typeof API.course === 'undefined') {
                    showMessage('API not loaded. Please refresh the page.', 'error');
                    return;
                }

                const form = $('#editCourseForm');
                const title = $('#editCourseTitle').val().trim();
                const description = $('#editCourseDescription').val().trim();
                const category = $('#editCourseCategory').val().trim();
                const priceInput = $('#editCoursePrice').val().trim();
                const thumbnail = $('#editCourseImage').val().trim();
                const duration = $('#editCourseDuration').val();
                const level = $('#editCourseLevel').val();

                // Validate required fields
                if (!title || title.length < 3) {
                    showMessage('Course title is required and must be at least 3 characters', 'error');
                    return;
                }

                if (!description || description.trim().length === 0) {
                    showMessage('Description is required', 'error');
                    return;
                }

                if (!category || category.trim().length === 0) {
                    showMessage('Category is required', 'error');
                    return;
                }

                // Properly handle price - ensure it's a valid number >= 0
                let price = 0;
                if (priceInput && priceInput !== '') {
                    const parsedPrice = parseFloat(priceInput);
                    if (isNaN(parsedPrice) || parsedPrice < 0) {
                        showMessage('Please enter a valid price (0 or greater)', 'error');
                        return;
                    }
                    price = parsedPrice;
                }

                // If new category was entered, add it to the list
                if (!courseCategories.includes(category)) {
                    courseCategories.push(category);
                    courseCategories.sort();
                    updateCategoryDropdowns();
                    updateCategoriesList();
                }

                const courseData = {
                    title: title,
                    description: description,
                    category: category,
                    price: price
                };

                // Add thumbnail if provided
                if (thumbnail) {
                    courseData.thumbnail = thumbnail;
                }

                // Add duration if provided
                if (duration) {
                    courseData.duration = parseInt(duration);
                }

                // Add level if provided
                if (level) {
                    courseData.level = level;
                }

                console.log('Updating course:', courseData);
                const response = await API.course.update(currentEditCourseId, courseData);

                if (response.success) {
                    showMessage('Course updated successfully!');
                    $('#editCourseModal').modal('hide');
                    currentEditCourseId = null;
                    loadCourses();
                    loadCategories(); // Reload categories to include new one
                } else {
                    // Show detailed error message
                    const errorMsg = response.message || response.error || 'Failed to update course';
                    showMessage(errorMsg, 'error');
                }
            } catch (error) {
                console.error('Error updating course:', error);
                // Check if error has validation details from backend
                let errorMessage = 'Failed to update course. Please try again.';

                if (error.response && error.response.data) {
                    const errorData = error.response.data;
                    if (errorData.message) {
                        errorMessage = errorData.message;
                    } else if (errorData.error) {
                        errorMessage = errorData.error;
                    } else if (errorData.details && Array.isArray(errorData.details)) {
                        // Joi validation errors
                        errorMessage = errorData.details.map(d => d.message).join(', ');
                    }
                } else if (error.message) {
                    errorMessage = error.message;
                }

                showMessage(errorMessage, 'error');
            }
        }

        // Delete course
        async function deleteCourse(id) {
            if (!confirm('Are you sure you want to delete this course? This action cannot be undone.')) {
                return;
            }

            try {
                if (typeof API === 'undefined' || typeof API.course === 'undefined') {
                    showMessage('API not loaded. Please refresh the page.', 'error');
                    return;
                }

                // Check for enrollments before attempting deletion
                try {
                    if (API.enrollment) {
                        const enrollmentsResponse = await API.enrollment.getAll({ courseId: id, limit: 1 });
                        if (enrollmentsResponse.success && enrollmentsResponse.data) {
                            const enrollments = enrollmentsResponse.data.enrollments || enrollmentsResponse.data || [];
                            if (enrollments.length > 0) {
                                showMessage('Cannot delete this course because it has active enrollments. Please cancel or complete all enrollments first.', 'error');
                                return;
                            }
                        }
                    }
                } catch (e) {
                    console.warn('Error checking enrollments:', e);
                }

                const response = await API.course.delete(id);

                if (response.success) {
                    showMessage('Course deleted successfully!');
                    $(`tr[data-course-id="${id}"]`).fadeOut(300, function () {
                        $(this).remove();
                        if ($('#coursesTable tbody tr').length === 0) {
                            loadCourses();
                        }
                    });
                } else {
                    const errorMsg = response.message || 'Failed to delete course';
                    if (errorMsg.includes('foreign key') || errorMsg.includes('constraint') || errorMsg.includes('Cannot delete')) {
                        showMessage('Cannot delete this course because it has related records (enrollments, payments, etc.). Please remove related records first or contact an administrator.', 'error');
                    } else {
                        showMessage(errorMsg, 'error');
                    }
                }
            } catch (error) {
                console.error('Error deleting course:', error);
                let errorMessage = error.message || 'Failed to delete course. Please try again.';
                if (errorMessage.includes('foreign key') || errorMessage.includes('constraint') || errorMessage.includes('Cannot delete')) {
                    showMessage('Cannot delete this course because it has related records (enrollments, payments, etc.). Please remove related records first or contact an administrator.', 'error');
                } else {
                    showMessage(errorMessage, 'error');
                }
            }
        }

        // Open edit course modal
        async function openEditCourseModal(courseId) {
            currentEditCourseId = courseId;

            try {
                if (typeof API === 'undefined' || typeof API.course === 'undefined') {
                    showMessage('API not loaded. Please refresh the page.', 'error');
                    return;
                }
                
                const response = await API.course.getById(courseId);
                if (response.success && response.data) {
                    const course = response.data.course || response.data;
                    const form = $('#editCourseForm');
                    $('#editCourseTitle').val(course.title || '');
                    $('#editCourseDescription').val(course.description || '');
                    $('#editCourseCategory').val(course.category || '');
                    $('#editCoursePrice').val(course.price || 0);
                    $('#editCourseImage').val(course.thumbnail || '');
                    $('#editCourseDuration').val(course.duration || '');
                    $('#editCourseLevel').val(course.level || '');

                    // Update image preview
                    if (course.thumbnail) {
                        $('#editCourseImagePreview').attr('src', course.thumbnail).show();
                        $('#editCourseImagePlaceholder').hide();
                    } else {
                        $('#editCourseImagePreview').hide().attr('src', '');
                        $('#editCourseImagePlaceholder').show();
                    }
                    
                    $('#editCourseModal').modal('show');
                } else {
                    showMessage(response.message || 'Failed to load course for editing', 'error');
                }
            } catch (error) {
                console.error('Error loading course for edit:', error);
                showMessage(error.message || 'Failed to load course for editing. Please try again.', 'error');
            }
        }

        // Image URL preview handler
        function setupImageUrlPreview(inputId, previewId, placeholderId) {
            $(`#${inputId}`).on('input', function () {
                const url = $(this).val().trim();
                if (url) {
                    // Show loading state
                    $(`#${placeholderId}`).html('<i class="icofont-spinner-alt icofont-spin" style="font-size: 1.5rem;"></i>');

                    // Test if URL is valid image
                    const img = new Image();
                    img.onload = function () {
                        $(`#${previewId}`).attr('src', url).show();
                        $(`#${placeholderId}`).hide();
                    };
                    img.onerror = function () {
                        $(`#${previewId}`).hide().attr('src', '');
                        $(`#${placeholderId}`).show().html('<i class="icofont-warning" style="font-size: 1.5rem; color: #dc3545;"></i><br>Invalid URL');
                    };
                    img.src = url;
                } else {
                    $(`#${previewId}`).hide().attr('src', '');
                    $(`#${placeholderId}`).show().html('<i class="icofont-image" style="font-size: 2rem; display: block;"></i>Image Preview');
                }
            });
        }

        // Set active menu item based on current page
        function setActiveMenuItem() {
            const currentPage = window.location.pathname.split('/').pop() || window.location.href.split('/').pop();
            $('.admin-tab-menu a').removeClass('active');
            $('.admin-tab-menu a').each(function() {
                const href = $(this).attr('href');
                if (href === currentPage || (currentPage === '' && href === 'super-admin-dashboard.html')) {
                    $(this).addClass('active');
                }
            });
        }

        // Logout function
        function handleLogout() {
            if (confirm('Are you sure you want to logout?')) {
                try {
                    if (typeof API !== 'undefined' && API.auth && API.auth.logout) {
                        API.auth.logout();
                    } else {
                        // Fallback if API not loaded
                        localStorage.removeItem('authToken');
                        localStorage.removeItem('user');
                        window.location.href = 'login.html';
                    }
                } catch (error) {
                    console.error('Error during logout:', error);
                    // Fallback logout
                    localStorage.removeItem('authToken');
                    localStorage.removeItem('user');
                    window.location.href = 'login.html';
                }
            }
        }
        
        // Load courses and tutors on page load
        $(document).ready(function () {
            // Set active menu item
            setActiveMenuItem();
            
            // Setup image URL previews
            setupImageUrlPreview('addCourseImage', 'addCourseImagePreview', 'addCourseImagePlaceholder');
            setupImageUrlPreview('editCourseImage', 'editCourseImagePreview', 'editCourseImagePlaceholder');

            if (typeof jQuery === 'undefined') {
                setTimeout(function () {
                    if (typeof jQuery !== 'undefined') {
                        loadCourses();
                        loadTutors();
                        loadCategories();
                    }
                }, 1000);
            } else {
                loadCourses();
                loadTutors();
                loadCategories();
            }
        });
    </script>

</body>

</html>